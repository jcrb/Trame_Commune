---
title: 'Activité des structures d’urgences : panorama 2014 de la région ALSACE'
author: "RESURAL (JcB)"
date: "28/01/2015"
output:
  pdf_document:
    keep_tex: yes
    number_sections: yes
    toc: yes
  html_document:
    highlight: pygments
    keep_md: yes
    number_sections: yes
    theme: cerulean
    toc: yes
---

Version mse à jour le: __`r date()`__

Ajout de la dernière version de Gilles 

- nombre de passages pour 10.000 hab.
- nombre de SU pour 10.000 hab.
- nombre de lignes SMUR financées par une MIG
- nombre de siège de SMUR dont SMUR saisonnier dont antenne SMUR dont hélismur
- séparer privés lucratifs et ESPIC
- nombre de logicels et nombre de SU par région
- SAE 2014 ?
- augmentation par rapport année N-1 en tenant compte uniquement des établissements "stables"
- séparer chu et non chu, samu de chu et de non chu
- retour attendu pour le 4/9

```{r titre, echo=FALSE}
anc <- 2014 # année courante
```

```{r Declarations, echo=FALSE, include=FALSE}
library(knitr)
options(scipen = 6, digits = 2)
ptm <- proc.time() # chronométrage
library(lubridate)
library(plotrix) # radialplot et pyramid.plot
library(xts)
library(R.utils)
library(epicalc)
library(stargazer)
library(xtable)

# set global chunk options
opts_chunk$set(echo = FALSE, cache=FALSE, warning=FALSE, message = FALSE, tidy=FALSE, fig.width=8, fig.height=6, scipen= 1, digits = 2)
```

```{r prerequis, echo=FALSE, comment="", message=FALSE}
# Quelle est la machine active ?
host <- System$getHostname()
if(host == "MacBook-Air-de-JCB.local" | host == "Air-de-JCB"){
    path <- "../../../Stat Resural/RPU_2014/"
    source("../../../Stat Resural/RPU_Doc/mes_constantes.R")
    # en mode console:
    # path <- "../../Stat Resural/RPU_2014/"
    # source("../../Stat Resural/RPU_Doc/mes_constantes.R")
    
}else if(host == "XPS"){#XPS
    path <- "../../Stat Resural/RPU_2014/"
    source("../../Stat Resural/RPU_Doc/mes_constantes.R")
}else if(host == "P171I16"){# HUS
    path <- "../RPU_2014-master/"
}

source('../Rapport/rapport_2014.R') # routines pour le rapport d'activité
# en mode console source('Rapport/rapport_2014.R')

test <- 0 # TRUE = Janvier 2015

if(test == 0){
    file <- "rpu2014d0112_c2.Rda" # données de 2014
    load(paste0(path, file))
    dx <- d14 # si file actif
    rm(d14)
}else{
    file <- "rpu2015d01.Rda" # fichier de test
    load(paste0(path, file))
    dx <- d01 
    rm(d01)
}

#source(paste0(path, "RPU_Doc/mes_constantes.R"))

n.rpu <- nrow(dx) # nb de passages dans l'année

# RPU corrigés: on retire les RPU où l'orientation est égale à "FUGUE","PSA","REO"
# sous forme de dataframe:
# dx.corrigee <- dx[!(dx$ORIENTATION %in% c("FUGUE","PSA","REO")),]
# nrow(dx.corrigee)
# sous forme de vecteur
dx.corrigee2 <- dx[!(dx$ORIENTATION %in% c("FUGUE","PSA","REO")),1]
n.rpu.corriges <- length(dx.corrigee2)
```

Activité des structures d’urgences : panorama `r anc` de la région ALSACE
=========================================================================
Rapport `r anc` respectant les préconisations de la FEDORU. Source:
[Trame commune](https://docs.google.com/document/d/101LYVqVLeHZnrujfMm3aqBYfbOwx3CPEB3Y-Lbud2Ls/edit)

Le document de référence pour le rapport est: __V4 trame commune 2014 rapport inter région__ (xps: /home/jcb/Documents/Resural/FEDORU/Trame_Commune/DOC/Trame commune 2014 rapport inter région (V4).docx)

__NOTE__: certaines informations utiles sont dans __RPU_Doc__.

LE MOT DU PRÉSIDENT DE LA FEDORU
================================

```{r test, child = '../mot_du_president_2014.Rmd'}
```

Description de l’offre de soins
===============================

Qualité des données 
-------------------
Réalisation d’un diagramme radar présentant l’exhaustivité des items RPU.

```{r completude, echo = FALSE, fig.width=10}
# calcul de la complétude. La complétude brute est corrigée pour les rubriques orientation et detination.
# comp <- completude(dx[, -c(1,7)]) # on retire les colonnes sans intérêt: id, EXTRACT
# on réordonne les colonnes (ordre FEDORU)
dx2 <- dx[, c("FINESS","id","EXTRACT","CODE_POSTAL","COMMUNE","NAISSANCE","SEXE","ENTREE","MODE_ENTREE","PROVENANCE","TRANSPORT","TRANSPORT_PEC","SORTIE","MODE_SORTIE","DESTINATION","ORIENTATION","MOTIF","GRAVITE","DP")]

comp <- completude(dx2, calcul = "percent")
s.comp <- completude(dx2, calcul = "somme")

rm(dx2)

# barplot
par(mar = c(4,6,3,1))
barplot(sort(comp), horiz = TRUE, las = 1, cex.names = 0.8, xlab = "% de complétude", main = "Complétude des champs RPU", col = "light green")
abline(v = 90, lty = 2, col = "red")

# Tracé du diagrame en étoile
par(mar =c (0,0,0,0))
radar.completude(completude(dx))
```

Complétude en valeur absolue et en pourcentages:`
```{r, echo=FALSE}
s.comp

comp
```

Les chiffres clés de l’activité des services d’urgences
=======================================================

Recueil des données
-------------------
```{r chiffres, echo=FALSE, comment=""}
anc <- 2014    # année courante
anp <- anc - 1 # année précédente
n.rpu <- nrow(dx) # nb de passages dans l'année
n.jours <- length(unique(as.Date(dx$ENTREE))) # nb de jours pour la période

periode.debut <- min(as.Date(dx$ENTREE))
periode.fin <- max(as.Date(dx$ENTREE))

publics <- c("Wis", "Hag", "Sav", "Hus", "Sel", "Geb", "Col", "Tan", "Alk", "Mul", "3Fr")
prives <- c("Odi", "Ane", "Dts", "Ros", "Dia")
n.su <- 16 # nombre de SU
n.su.ped <- 1 # nombre de SU pediatriques
n.su.adultes <- 2 # nombre de SU adultes
n.su.polyvalents <- 13
n.su.publics <- 12
n.su.prives <- 4

mean.rpu.quot <- n.rpu / n.jours # Moyenne quotidienne de passages

#---------------------- Chiffres ---------------------------------------------------------------
chiffres <- c(anc, periode.debut, periode.fin, n.jours, n.su.ped, n.su.adultes, n.su.polyvalents, n.su.publics, n.su.prives, n.rpu, mean.rpu.quot)
names(chiffres) <- c("anc", "periode.debut", "periode.fin", "n.jours", "n.su.ped", "n.su.adultes", "n.su.polyvalents", "n.su.publics", "n.su.prives", "n.rpu", "mean.rpu.quot")
#---------------------- Chiffres end ------------------------------------------------------------
```

- Nombre de passages dans l'année [C]: `r format.n(n.rpu)` RPU
- Moyenne quotidienne de passages [C]: `r format.n(mean.rpu.quot)` RPU
- %(N) d'évolution par rapport à année N-1 [C]: `r format(n.rpu * 100 / n.rpu.2013)` %.
- % d’évolution moyenne sur les 5 dernières années (méthode calcul : moyenne des évolutions constatées entre chaque année)
- Données renseignées (données à partir desquelles tout le reste de l’analyse sera effectuée)
    - Nombre de RPU transmis: `r format.n(n.rpu)` RPU
    - Exhaustivité du recueil : Nb RPU transmis / Nb de passages déclarés `r format.n(n.rpu * 100 / passages.2013.SAE)` % (NOTE le nombre de passages déclarés est celui indiqué par les données SAE 2013)

PATIENTS
--------
### Sexe
```{r sexe, echo=FALSE, comment=""}
sexe <- table(as.factor(dx$SEXE))
p.femme <- sexe['F']*100/(sexe['F'] + sexe['M']) # % de femmes
p.homme <- sexe['M']*100/(sexe['F'] + sexe['M']) # % d'hommes
sex.ratio <- sexe['M'] / sexe['F'] # sex ratio
n.hommes <- sexe['M']
n.femmes <- sexe['F']
tx.masculinite <- n.hommes / (n.hommes + n.femmes)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(p.femme, p.homme, n.femmes, n.hommes, tx.masculinite)
names(val) <- c("p.femme", "p.homme", "n.femmes", "n.hommes", "tx.masculinite")
chiffres <- c(chiffres, val)
#---------------------- Chiffres end -----------------------------------------------------------

```

- %(N) Femme [C]: `r round(p.femme, 2)` % (`r format(sexe['F'], big.mark = " ")`)
- %(N) Homme [C]: `r round(p.homme, 2)` % (`r format(sexe['M'], big.mark = " ")`)
- Sex ratio: `r sex.ratio`
- Taux de masculinité: `r tx.masculinite`

### Age
```{r age, echo=FALSE, comment=""}
n.inf1an <- sum(dx$AGE < 1, na.rm = TRUE)
n.supegal90 <- sum(dx$AGE > 89, na.rm = TRUE)
p.inf1an <- mean(dx$AGE < 1, na.rm = TRUE)

n.inf15an <- sum(dx$AGE < 15, na.rm = TRUE)
p.inf15an <- mean(dx$AGE < 15, na.rm = TRUE)

n.inf18an <- sum(dx$AGE < 18, na.rm = TRUE)
p.inf18an <- mean(dx$AGE < 18, na.rm = TRUE)

n.supegal75an <- sum(dx$AGE >= 75, na.rm = TRUE)
p.supegal75an <- mean(dx$AGE >= 75, na.rm = TRUE)
mean.age <- mean(dx$AGE, na.rm = TRUE)
sd.age <- sd(dx$AGE, na.rm = TRUE)
median.age <- median(dx$AGE, na.rm = TRUE)

mean.age.sexe <- tapply(dx$AGE, dx$SEXE, mean, na.rm = TRUE)
mean.age.h <- mean.age.sexe['M'] # age moyen des hommes
mean.age.f <- mean.age.sexe['F'] # age moyen des femmes

sd.age.sexe <- tapply(dx$AGE, dx$SEXE, sd, na.rm = TRUE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(n.inf1an, n.supegal90, p.inf1an, n.inf15an, p.inf15an, n.inf18an, p.inf18an, n.supegal75an, p.supegal75an, mean.age, sd.age, median.age, mean.age.h, mean.age.f)
names(val) <- c("n.inf1an", "n.supegal90", "p.inf1an", "n.inf18an", "p.inf18an", "n.supegal75an", "p.supegal75an", "mean.age", "sd.age", "median.age", "mean.age.h", "mean.age.f")
chiffres <- c(chiffres, val)

#---------------------- Chiffres end ------------------------------------------------------------
```

- age moyen[C]: `r round(mean.age, 2)` ans.
- age moyen des hommes [S]: `r round(mean.age.sexe['M'], 2)` ans.
- age moyen des femmes [S]: `r round(mean.age.sexe['F'], 2)` ans.

- % (N) < 1 an [C]: `r format.n(n.inf1an)` (`r round(100 * p.inf1an, 2)` %)
- %(N) < 15 ans [C]: `r format.n(n.inf15an)` (`r round(100 * p.inf15an, 2)` %)
- %(N) < 18 ans [C]: `r format.n(n.inf18an)` (`r round(100 * p.inf18an, 2)` %)
- %(N) >= 75 ans [C]: `r format.n(n.supegal75an)` (`r round(100 * p.supegal75an, 2)` %)
- Pyramide des ages:

```{r pyramide, echo=FALSE, message=FALSE}
# faire une fonction générique
# par tranche d'age de 5 ans, borne sup exclue: [0-5[ ans
a <- cut(dx$AGE, seq(from = 0,to = 120, by = 5), include.lowest = TRUE, right = FALSE)
h <- as.vector(100 * table(a[dx$SEXE == "M"])/n.rpu)
f <- as.vector(100 * table(a[dx$SEXE == "F"])/n.rpu)
pyramid.plot(h,f, labels = names(table(a)), top.labels = c("Hommes", "Age", "Femmes"), main = "Pyramide des ages", lxcol = "light green", rxcol = "khaki1")

#---------------------- Chiffres ---------------------------------------------------------------
#---------------------- Chiffres end -----------------------------------------------------------

```

### Taux de recours (définition FEDORU) régional aux urgences. [S]
Utilisation des données INSEE qui collent le plus à la période d’étude (projections ou données consolidées)
```{r tarru, echo=FALSE}
# pop.als.tot.2014 <- 1868773 # chiffre insee au 1/1/2014 (http://www.insee.fr/fr/themes/tableau.asp?reg_id=15&ref_id=poptc02104)
pop.als.tot <- population("Alsace", anc)
residents <- sum(sapply(dx$CODE_POSTAL, is.cpals))
tarru <- residents * 100 / pop.als.tot

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(pop.als.tot, residents, tarru)
names(val) <- c("pop.als.tot", "residents", "TARRU")
chiffres <- c(chiffres, val)
#---------------------- Chiffres end -----------------------------------------------------------

```

TARRU: __`r tarru`%__ (ref: population alsacienne `r anc`)

### %  de patients ne venant pas de la région (étranger compris)
```{r etrangers, echo=FALSE}
x <- as.character(dx$CODE_POSTAL)
b <- substr(x,1,2)
org_als <- b[b == "67" | b == "68"]
n.org_als <- length(org_als)
p.org_als <- n.org_als / n.rpu

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(n.org_als, p.org_als)
names(val) <- c("nb_alsaciens", "p_alsaciens")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

`r (1 - p.org_als) * 100`% (N = `r n.rpu - n.org_als)

ARRIVÉE
-------
```{r horaires_pds, echo=FALSE}
# ajout dd'une colonne horaires de PDS
dx$HPDS <- pds(dx$ENTREE)
```

### Horaires de passage
```{r horaires}
# la plupart des instructions qui suivent ont été transformée en fonctions. Voir rapport2014.R notamment passage(), horaire() et datetime().

passages <- dx[, c("ENTREE", "SORTIE")] # dataframe entrées-sorties
passages <- passages[complete.cases(passages),] # on ne conserve que les couples complets
n.passages <- nrow(passages)
e <- ymd_hms(passages$ENTREE) # vecteur des entrées
s <- ymd_hms(passages$SORTIE)

# horaires seuls. Il faut isoler les heures de la date
he <- hms(substr(e, 12, 20)) # heures d'entrée
hs <- hms(substr(s, 12, 20)) # heures de sortie
# graphique des entrées
x <- barplot(table(hour(he)), main = "Heures d'entrée", ylab = "Fréquence", xlab = "Heures")
#x

# passages de nuit (nécessite lubridate) library(lubridate)
# nombre de passages dont l’admission s’est effectuée sur la période [20h00 - 7h59] divisé par l’ensemble des passages
nuit <- he[he > hms("19:59:59") | he < hms("08:00:00")]
n.passages.nuit <- length(nuit) # passages 20:00 - 7:59
p.passages.nuit <- n.passages.nuit / n.passages

# passages en nuit profonde
#nombre de passages dont l’admission s’est effectuée sur la période [00h00 - 7h59] divisé par l’ensemble des passages
# NB VOIR ROUTINE passages()
nuit.profonde <- he[he < hms("08:00:00")]
n.passages.nuit.profonde <- length(nuit.profonde)
p.passages.nuit.profonde <- n.passages.nuit.profonde / n.passages

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(n.passages,n.passages.nuit, p.passages.nuit, n.passages.nuit.profonde, p.passages.nuit.profonde)
names(val) <- c("Passages.48H", "Passages.N", "Passages.NP", "%Passages.N", "%Passages.NP")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- % passages nuit [C]: `r round(p.passages.nuit * 100, 2)` % (N = `r format.n(n.passages.nuit)`)
- % passages nuit profonde [C]: `r round(p.passages.nuit.profonde * 100, 2)` % (N = `r format.n(n.passages.nuit.profonde)`)

```{r passage_pds, echo=FALSE, comment=""}
# utilise le fichier horaires_pds.Rda
load("~/Documents/RESURAL/Trame_Commune/horaires_pds.Rda")
s.pds <- summary(as.factor(h.pds))
p.s.pds <- prop.table(s.pds)
p.pds <- p.s.pds["PDSS"] + p.s.pds["PDSWE"] # % de passages aux haoraires de PDS
n.pds <- s.pds["PDSS"] + s.pds["PDSWE"] # nombre de passages aux haoraires de PDS

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(p.pds)
names(val) <- c("Passages.PDS")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- %  passages en horaire de PDS: `r p.pds * 100` % [N = `r n.pds`](Remarque: ne tient pas compte des jours fériés survenant en semaine)

### Variations saisonnières
```{r saison, echo=FALSE}
# nombre de passages en juillet-aout
n.rpu.ete <- length(dx[as.Date(dx$ENTREE) > "2014-06-30" & as.Date(dx$ENTREE) < "2014-09-01", "ENTREE"])
mean.rpu.ete <- n.rpu.ete / 62 # nb moyen de rpu en été
# nb de passages le reste de l'année
n.rpu.autre.mois <- n.rpu - n.rpu.ete
mean.rpu.autre <- n.rpu.autre.mois / 303
# évolution
t <- (mean.rpu.ete - mean.rpu.autre) / mean.rpu.autre
```
Variation du nombre de RPU entre les mois d'été (juillet-août) et les autres mois de l'année: `r t * 100` %

### Moyens d'arrivée
```{r transpport, echo=FALSE, comment=""}
transport <- table(dx$TRANSPORT)
n.transport <- sum(transport) # nb de moyens de transport renseignés
n.transport.perso <- transport['PERSO']
n.transport.ambu <- transport['AMBU']
n.transport.fo <- transport['FO']
n.transport.heli <- transport['HELI']
n.transport.smur <- transport['SMUR']
n.transport.vsab <- transport['VSAB']

p.transport.perso <- transport['PERSO'] / n.transport
p.transport.ambu <- transport['AMBU'] / n.transport
p.transport.fo <- transport['FO'] / n.transport
p.transport.heli <- transport['HELI'] / n.transport
p.transport.smur <- transport['SMUR'] / n.transport
p.transport.vsab <- transport['VSAB'] / n.transport

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(n.transport, n.transport.perso, n.transport.ambu, n.transport.fo, n.transport.heli, n.transport.smur, n.transport.vsab, p.transport.perso, p.transport.ambu, p.transport.fo, p.transport.heli, p.transport.smur, p.transport.vsab)
names(val) <- c("n.transport", "PERSO", "AMBU", "FO", "HELI", "SMUR", "VSAB", "p.PERSO", "P.AMBU", "p.FO", "p.HELI", "p.SMUR", "p.VSAB")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- __%(N) d'arrivée personnel__ [S]: `r round(n.transport.perso * 100 / n.transport, 2)` % (N = `r format.n(n.transport.perso)`)
- __%(N) d'arrivée SMUR__ [S]: `r round(n.transport.smur * 100 / n.transport, 2)` % (N = `r format.n(n.transport.smur)`)
- __%(N) d'arrivée VSAB__ [S]: `r round(n.transport.vsab * 100 / n.transport, 2)` % (N = `r format.n(n.transport.vsab)`)
- __%(N) d'arrivée Ambulance__ [S]: `r round(n.transport.ambu * 100 / n.transport, 2)` % (N = `r format.n(n.transport.ambu)`)

NB : commentaire possible pour expliquer que la somme des 4 pourcentages ci dessus ne fait pas 100 %

### Gravité (CCMU)

```{r ccmu, echo=FALSE, comment=""}
ccmu <- summary(as.factor(dx$GRAVITE)) # nb de ccmu par catégories
s.ccmu <- sum(ccmu[1:7]) # on retire les NA
n.ccmu1 <- ccmu[1]
p.ccmu1 <- n.ccmu1 / s.ccmu
n.ccmu12 <- ccmu[1] + ccmu[2] 
p.ccmu12 <- n.ccmu12 / s.ccmu
n.ccmu45 <- ccmu[4] + ccmu[5] 
p.ccmu45 <- n.ccmu45 / s.ccmu
n.ccmu.d <- ccmu[6]
p.ccmu.d <- n.ccmu.d / s.ccmu
n.ccmu.p <- ccmu[7]
p.ccmu.p <- n.ccmu.p / s.ccmu

# Exhaustivité CCMU 
ccmu.corrigee <- dx$GRAVITE[!(dx$ORIENTATION %in% c("FUGUE","PSA","REO"))] # on ne tient pas compte des RPU dont le motif ORIENTATION = fugue, reo ou psa
n.ccmu.utilisable <- length(ccmu.corrigee)
n.ccmu.conforme <- sum(!is.na(ccmu.corrigee)) # Nombre de RPU 2014 hors orientation = FUGUE, PSA et REO ayant un élément transmis pour la CCMU


#---------------------- Chiffres ---------------------------------------------------------------
val <- c(n.ccmu12, n.ccmu45, n.ccmu.utilisable, n.ccmu.conforme, s.ccmu)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```
- nombre de CCMU renseignés: `r s.ccmu`
- __%(N) CCMU 1 __ [C]: `r round(100 * p.ccmu1, 2)`% (n = `r format.n(n.ccmu1)`)
- __%(N) CCMU 1 et 2__ [C]: `r round(100 * p.ccmu12, 2)`% (n = `r format.n(n.ccmu12)`)
- __%(N) CCMU 4 et 5__ [C]: `r round(100 * p.ccmu45, 2)`% (n = `r format.n(n.ccmu45)`)

Exhaustivité CCMU :
- Nombre de RPU 2014 hors orientation = FUGUE, PSA et REO ayant un élément transmis pour la CCMU: `r n.ccmu.conforme`

DIAGNOSTIC PRINCIPAL 

Remarque: les chiffres sont dans le document _Codes_regroupement_ORUMIP_ => à rajouter.

- %  Médico-chirurgical 
- %  Traumatologique
- %  Psychiatrique
- %  Toxicologique
- %  Autres recours

### Durées de passage

```{r passages, echo=FALSE, comment=""}
# On forme un dataframe avec les heures d'entrées et de sortie auxquelle on rajoute pour certains calculs: Mode_Sortie
passages <- dx[, c("ENTREE", "SORTIE", "MODE_SORTIE")] # dataframe entrées-sorties
passages <- passages[complete.cases(passages),] # on ne conserve que les couples complets
n.passages <- nrow(passages)
e <- ymd_hms(passages$ENTREE) # vecteur des entrées
s <- ymd_hms(passages$SORTIE)
d <- as.numeric((s-e)/60) # vecteur des durées de passage en minutes
passages$duree <- d

# on ne garde que les passages dont la durées > 0 et < ou = 72 heures
passages <- passages[passages$duree > 0 & passages$duree < 3 * 24 * 60 + 1,]
n.duree <- nrow(passages) # nb total de durées
s.duree <- summary(passages$duree) # résumé des durées totales de passage
hist(passages$duree/60, breaks = 72, xlab = "Heures", main = paste0("Durées de passage en ", anc), col= "cornflowerblue", border = "white")
mean.duree <- s.duree['Mean']
median.duree <- s.duree['Median']
sd.duree <- sd(passages$duree)
# nb de passages dont la durée est supérieure à 4 heures:
duree.sup.4h <- passages$duree[passages$duree > 4 * 60] # vecteur des durées sup 4 h
n.duree.sup.4h <- length(duree.sup.4h) # nb de passages > 4h
p.duree.sup.4h <- n.duree.sup.4h / n.duree

# nb  de passages dont la durée est inférieure à 4 heures:
duree.inf.4h <- passages$duree[passages$duree <= 4 * 60] # vecteur des durées inf 4 h
n.duree.inf.4h <- length(duree.inf.4h) # nb de passages > 4h
p.duree.inf.4h <- n.duree.inf.4h / n.duree

# intervalle interquartile
iqr.duree <- s.duree['3rd Qu.'] - s.duree['1st Qu.']

# ancien code avec le vecteur durée
# duree <- d[d > 0 & d < 3 * 24 * 60 + 1]
# n.duree <- length(duree) # nb total de durées
# s.duree <- summary(duree) # résumé des durées totales de passage
# mean.duree <- s.duree['Mean']
# median.duree <- s.duree['Median']
# sd.duree <- sd(duree)
# # nb de passages dont la durée est supérieure à 4 heures:
# duree.sup.4h <- duree[duree > 4 * 60] # vecteur des durées sup 4 h
# n.duree.sup.4h <- length(duree.sup.4h) # nb de passages > 4h
# p.duree.sup.4h <- n.duree.sup.4h / n.duree
# 
# # nb  de passages dont la durée est inférieure à 4 heures:
# duree.inf.4h <- duree[duree <= 4 * 60] # vecteur des durées inf 4 h
# n.duree.inf.4h <- length(duree.inf.4h) # nb de passages > 4h
# p.duree.inf.4h <- n.duree.inf.4h / n.duree
# 
# # intervalle interquartile
# iqr.duree <- s.duree['3rd Qu.'] - s.duree['1st Qu.']

# Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'une hospitalisation post-urgences
duree.hosp <- passages[passages$MODE_SORTIE %in% c("Mutation","Transfert"), "duree"]
n.duree.hosp <- length(duree.hosp)
# durée moyenne de passage si hospitalisation
mean.duree.hosp <- mean(duree.hosp)
median.duree.hosp <- median(duree.hosp)
# Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une hospitalisation post-urgences
duree.hosp.inf4h <- passages[passages$MODE_SORTIE %in% c("Mutation","Transfert") & passages$duree < 4*60, "duree"]
n.duree.hosp.inf4h <- length(duree.hosp.inf4h)

# Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'un retour au domicile
duree.domicile <- passages[passages$MODE_SORTIE == "Domicile", "duree"]
n.duree.domicile <- length(duree.domicile)
# durée moyenne de passage si retour à domicile
mean.duree.domicile <- mean(duree.domicile)
median.duree.domicile <- median(duree.domicile)
# Nombre de RPU dont la durée de passage est inférieure à 4h lors d'un retour au domicile
duree.domicile.inf4h <- passages[passages$MODE_SORTIE == "Domicile" & passages$duree < 4*60, "duree"]
n.duree.domicile.inf4h <- length(duree.domicile.inf4h)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Nb de RPU dont la durée de passage est comprise entre 0 et 72h: `r n.duree`
- durée moyenne de passage `r mean.duree` mn.
- écart-type: `r sd.duree` mn.
- médiane: `r median.duree` mn.
- nombre de passages > 4 heures: `r format.n(n.duree.sup.4h)` (`r round(p.duree.sup.4h * 100, 2)` %).
- nombre de passages inférieurs ou égaux à 4 heures: `r format.n(n.duree.inf.4h)` (`r round(p.duree.inf.4h * 100, 2)` %).

- Lors d’une hospitalisation post-urgences (hospitalisation = mutation + transfert)
    - médiane durée de passage en cas de retour à domicile: __104 minutes__.
    - médiane durée de passage en cas d’hospitalisation: __148 minutes__.
- Lors d’un retour au domicile
    - moyenne durée de passage en cas de retour à domicile: __145.87 minutes__.
    - moyenne durée de passage en cas d’hospitalisation: __187.55 minutes__.

(source: temps de passages.Rmd)

### MODE DE SORTIE
```{r mode_sortie, echo=FALSE, comment=""}
mode.sortie <- table(dx$MODE_SORTIE) # mode de sortie par type
n.mode.sortie <- sum(mode.sortie) # nb de mode de sortie renseigné
n.externes <- mode.sortie['Domicile'] # nb de sortants
n.mutations <- mode.sortie['Mutation'] # nb d'hospitalisés
n.transferts <- mode.sortie['Transfert'] # nb de transferts
n.hospitalises <- n.mutations + n.transferts
n.deces <- mode.sortie['DCD']

p.externes <- mode.sortie['Domicile'] / n.mode.sortie
p.mutations <- mode.sortie['Mutation'] / n.mode.sortie
p.transferts <- mode.sortie['Transfert'] / n.mode.sortie
p.hospitalises <- n.hospitalises / n.mode.sortie
p.deces <- mode.sortie['DCD'] / n.mode.sortie

# Exhaustivité Destination (lors d'une hospitalisation) 
#Nb de RPU 2014  avec mode de sortie = 6 ou 7 avec un élément transmis pour la destination
hosp.dest <- dx[dx$MODE_SORTIE %in% c("Mutation","Transfert"), "DESTINATION"]
n.hosp.dest <- sum(!is.na(hosp.dest))

# Exhaustivité Orientation lors d'une hospitalisation    
# Nb de RPU 2014 avec mode de sortie = 6 ou 7 avec un élement transmis pour l'orientation
hosp.orient <- dx[dx$MODE_SORTIE %in% c("Mutation","Transfert"), "ORIENTATION"]
n.hosp.orient <- sum(!is.na(hosp.orient))

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- % (N) de retour à domicile: `r round(n.externes * 100 / n.mode.sortie, 2)` % (N = `r format.n(n.externes)`)
- % (N) Hospitalisation: `r round(n.hospitalises * 100 / n.mode.sortie, 2)` % (N = `r format.n(n.hospitalises)`)
- % (N) Mutation: `r round(n.mutations * 100 / n.mode.sortie, 2)` % (N = `r format.n(n.mutations)`)
- % (N) Transfert: `r round(n.transferts * 100 / n.mode.sortie, 2)` % (N = `r format.n(n.transferts)`)
- Nb de RPU 2014  avec mode de sortie = 6 ou 7 (hospitalisation) avec un élément transmis pour la destination: `r n.hosp.dest`
- Nb de RPU 2014 avec mode de sortie = 6 ou 7 avec un élement transmis pour l'orientation: `r n.hosp.orient`


Les chiffres clés de l’activité des SAMU
========================================
 (à partir des données SRVA "officielles")
 
```{r chiffres_2014, echo=FALSE}
# source: samu.Rmd pour l'année 2014
drm <- 480303
smur_primaires <- 19714        
smur_secondaires <- 5070         
smur_neonat <- 537
assu <- 46031

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- Nombre de dossiers de régulation médicale (DRM): `r drm`
- Nombre de SMUR : `r format.n(smur_primaires + smur_secondaires + smur_neonat)`
    - dont primaires: format.n(`r smur_primaires`)
- Nombre d’ambulances privées à la demande du SAMU: format.n(`r assu`)

Les chiffres clés de l’activité pédiatrique des services d’urgences (moins de 18 ans)
=====================================================================================

```{r pop18, echo=FALSE}
n.jours <- length(unique(as.Date(dx$ENTREE))) # nb de jours pour la période
n.rpu <- nrow(dx)

pop18 <- dx[!is.na(dx$AGE) & dx$AGE < 18,]
# age est un objet de type difftime exprimé en jours
age2 <- as.Date(pop18$ENTREE) - as.Date(pop18$NAISSANCE)
age2 <- as.numeric(age2)

# on retire les valeurs aberrantes: mois de 1 jour et plus de 120 ans
age2 <- age2[age2 > 1 & age2 < 365*18]
age2_an <- round(age2/365, 0)
# crée une nouvelle colonne age à 2 classes: < 28J, 28j-1an, 1-5 ans, 5-10, 10-15, 15-18
ped_jours <- c(1, 28, c(1, 5, 10, 15, 18) * 365) # bornes pour la pédiatrie en jour
# classes FEDORU pour la pédiatrie. La borne inférieure est incluse (include.lowest) et la borne sup est exclue (right = FALSE)
lab <- c("<28j", "28j-1an[", "1-5ans[", "5-10ans[", "10-15ans[", "15-18ans[")
ped <- cut(age2, ped_jours, include.lowest = TRUE, right = FALSE, labels = lab)

table(ped)
barplot(table(ped), main = "Pédiatrie")

# nombre
n.rpu18 <- nrow(pop18)
n.pop18 <- nrow(pop18) # conserver plutôt que n.rpu18

mean.rpu18 <- n.rpu18 / n.jours # Moyenne quotidienne de passages
p.rpu18 <- n.rpu18 * 100 / n.rpu # Taux d'urgences gériatriques

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

RECUEIL DES DONNÉES
-------------------
- Nombre de passages dans l'année: `r format.n(n.rpu18)`
- Moyenne quotidienne de passage: `r format.n(mean.rpu18)` passages/j
- Taux d'urgences pédiatriques [(Nb RPU Pédia/ Nb RPU global)x100]: `r format.n(p.rpu18)` %
- TODO: % d'évolution par rapport à l'année N-1(données SAE pour ceux qui n’ont pas d’historique RPU fiable et permettant la comparaison, préciser l’origine des données)

PATIENTS
--------
```{r sexe18, echo=FALSE, comment=""}
sexe <- table(as.factor(pop18$SEXE))
p.femme18 <- sexe['F']*100/(sexe['F'] + sexe['M']) # % de femmes
p.homme18 <- sexe['M']*100/(sexe['F'] + sexe['M']) # % d'hommes
sex.ratio18 <- sexe['M'] / sexe['F'] # sex ratio
n.hommes18 <- sexe['M']
n.femmes18 <- sexe['F']
tx.masculinite18 <- n.hommes18 / (n.hommes18 + n.femmes18)

# Par sous classe d’âge (GT1:2 classes, moins de 85 et 85 ans et plus)
# n.rpu2 <- tapply(pop18$age2, pop18$age2, length) # effectif de chaque classe

# nb de passages par jour et par sous classe d'age. On applique successivement tapply pour former 2 groupes d'age puis apply pour calculer moyenne, médiane, sd sur chacune des 2 colonnes (groupes d'age).
#n.rpu2.jour <- tapply(as.Date(pop18$ENTREE), list(as.Date(pop18$ENTREE), pop18$age2), length)

# calcul des paramètres par sous classe d'age
# mean.rpu.jour <- apply(n.rpu2.jour, 2, mean)
# median.rpu2.jour <- apply(n.rpu2.jour, 2, median)
# sd.rpu2.jour <- apply(n.rpu2.jour, 2, sd)
# 
# boxplot(n.rpu2.jour, names = c("18-84 ans","85 ans et plus"), ylab = "Fréquence", main = "Passages gériatriques")

# sex-ratio
# n.sexe2 <- tapply(pop18$SEXE, list(pop18$age2, pop18$SEXE), length)
# sr1 <- n.sexe2[1,"M"]/n.sexe2[1,"F"] # moins de 85 ans
# sr2 <- n.sexe2[2,"M"]/n.sexe2[2,"F"] # plus de 85 ans

# tableau desynthèse
# a <- data.frame(n.rpu2,mean.rpu.jour, median.rpu2.jour, c(sr1,sr2) )
# rownames(a) <- c("18-84 ans","85 ans et plus")
# colnames(a) <- c("effectif", "moyenne par jour ","médiane par jour", "sex ratio")
# a

# moyen de transport
summary(pop18$TRANSPORT)
# Nombre de RPU avec un moyen de transport renseigné
sum(!is.na(pop18$TRANSPORT))
# Nombre de RPU avec une CCMU renseignée
sum(!is.na(pop18$GRAVITE))
# nombre de CCMU
summary(pop18$GRAVITE)


#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```
- nombre de garçons: `r n.hommes18`
- nombre de filles: `r n.femmes18`
- Sex ratio: `r sex.ratio18`
- Pyramide des âges (âge par année, borne supérieure toujours exclue)
- Par sous classes d’âge:
```{r sous_classe_age_ped, echo=FALSE}
 # kable(a)
```

### horaires de passages pédiatriques
```{r passages_ped, echo=FALSE}
# nombre de passages de nuit 20h-8h
n.passages.nuit <- passages2(pop18$ENTREE, "nuit")
p.passages.nuit <- n.passages.nuit / n.pop18

n.passages.nuit.profonde <- passages2(pop18$ENTREE, "nuit_profonde")
p.passages.nuit.profonde <- n.passages.nuit.profonde / n.pop18
#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```
- nombre de passages la nuit: `r n.passages.nuit` (p = `r p.passages.nuit * 100` %)
- nombre de passages en nuit profonde: `r n.passages.nuit.profonde` (p = `r p.passages.nuit.profonde * 100` %)

### Durée de passage

```{r ped_duree_passage, echo=FALSE}
tmax <- 4 * 60 + 1 # < 4 heures
ped.dp <- duree.passage2(pop18)
ped.conforme <- nrow(ped.dp)
ped.duree.moyenne.passage <- mean(ped.dp$duree)
ped.duree.mediane.passage <- median(ped.dp$duree)
ped.passage4 <- length(ped.dp$duree[ped.dp$duree < tmax]) #nb passages < 4h
s.ped.mode.sortie <- summary(ped.dp$MODE_SORTIE)

ped.hosp.passage4 <- length(ped.dp$duree[ped.dp$duree < tmax & ped.dp$MODE_SORTIE %in% c("Mutation","Transfert")]) #nb passages < 4h et hospitalisation

ped.dom.passage4 <- length(ped.dp$duree[ped.dp$duree < tmax & ped.dp$MODE_SORTIE == "Domicile"]) #nb passages < 4h et retourà domicile

s.mode.sortie <- summary(pop18$MODE_SORTIE)
# Nombre de mutation interne
n.ped.mutation <- s.mode.sortie["Mutation"]
# nb de transfert
n.ped.transfert <- s.mode.sortie["Transfert"]
# nb de retour à domicile
n.ped.domicile <- s.mode.sortie["Domicile"]

```
- Nombre de RPU avec une heure de sortie conforme (]0-72h[: `r nrow(ped.dp)`
- Durée moyenne de passage (en min): `r ped.duree.moyenne.passage` mn
- Durée médiane de passage (en min): `r ped.duree.mediane.passage` mn
- Nombre de RPU dont la durée de passage est inférieure à 4h: `r ped.passage4`
- Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'une hospitalisation post-urgences: `r s.ped.mode.sortie["Mutation"] + s.ped.mode.sortie["Transfert"]`
- Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'un retour au domicile: `r s.ped.mode.sortie["Domicile"]`
- Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une hospitalisation post-urgences: `r ped.hosp.passage4`
- Nombre de RPU dont la durée de passage est inférieure à 4h lors d'un retour au domicile: `r ped.dom.passage4`

- Nombre de RPU avec un mode de sortie renseigné: `r sum(!is.na(pop18$MODE_SORTIE))`
- Nombre de mutation interne: `r n.ped.mutation`
- Nombre de transfert externe: `r n.ped.transfert`
- nombre de retours à domicile: `r n.ped.domicile`

Les chiffres clés de l’activité gériatrique des services d’urgences (75 ans et plus)
====================================================================================
```{r pop75, echo=FALSE}
n.jours <- length(unique(as.Date(dx$ENTREE))) # nb de jours pour la période
n.rpu <- nrow(dx)

pop75 <- dx[!is.na(dx$AGE) & dx$AGE > 74,]
# crée une nouvelle colonne age à 2 classes: mois de 85 ans = 1, 85 ans et plus = 2
pop75$age2 <- ifelse(pop75$AGE < 85, 1, 2)
# nombre
n.rpu75 <- nrow(pop75)
mean.rpu75 <- n.rpu75 / n.jours # Moyenne quotidienne de passages
p.rpu75 <- n.rpu75 * 100 / n.rpu # Taux d'urgences gériatriques

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
RECUEIL DES DONNÉES
-------------------
- Nombre de passages dans l'année: `r format.n(n.rpu75)`
- Moyenne quotidienne de passage: `r format.n(mean.rpu75)` passages/j
- Taux d'urgences gériatriques [(Nb RPU Géria/ Nb RPU global)x100]: `r p.rpu75` %
- TODO: % d'évolution par rapport à l'année N-1(données SAE pour ceux qui n’ont pas d’historique RPU fiable et permettant la comparaison, préciser l’origine des données)

PATIENTS
--------
```{r sexe75, echo=FALSE, comment=""}
s.sexe75 <- summary.sexe(pop75$SEXE)

# sexe <- table(as.factor(pop75$SEXE))
p.femme75 <- s.sexe75['p.femmes'] # % de femmes
p.homme75 <- s.sexe75['p.hommes'] # % d'hommes
sex.ratio75 <- s.sexe75['sex.ratio'] # sex ratio
n.hommes75 <- s.sexe75['n.hommes']
n.femmes75 <- s.sexe75['n.femmes']
tx.masculinite75 <- s.sexe75['tx.masculinité']

# Par sous classe d’âge (GT1:2 classes, moins de 85 et 85 ans et plus)
n.rpu2 <- tapply(pop75$age2, pop75$age2, length) # effectif de chaque classe

# nb de passages par jour et par sous classe d'age. On applique successivement tapply pour former 2 groupes d'age puis apply pour calculer moyenne, médiane, sd sur chacune des 2 colonnes (groupes d'age).
n.rpu2.jour <- tapply(as.Date(pop75$ENTREE), list(as.Date(pop75$ENTREE), pop75$age2), length)

# calcul des paramètres par sous classe d'age
mean.rpu.jour <- apply(n.rpu2.jour, 2, mean)
median.rpu2.jour <- apply(n.rpu2.jour, 2, median)
sd.rpu2.jour <- apply(n.rpu2.jour, 2, sd)

boxplot(n.rpu2.jour, names = c("75-84 ans","85 ans et plus"), ylab = "Fréquence", main = "Passages gériatriques")

# sex-ratio
n.sexe2 <- tapply(pop75$SEXE, list(pop75$age2, pop75$SEXE), length)
sr1 <- n.sexe2[1,"M"]/n.sexe2[1,"F"] # moins de 85 ans
sr2 <- n.sexe2[2,"M"]/n.sexe2[2,"F"] # plus de 85 ans

# tableau desynthèse
a <- data.frame(n.rpu2,mean.rpu.jour, median.rpu2.jour, c(sr1,sr2) )
rownames(a) <- c("75-84 ans","85 ans et plus")
colnames(a) <- c("effectif", "moyenne par jour ","médiane par jour", "sex ratio")
a

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- Nombre d'hommes: `r format.n(n.hommes75)`
- Nombre de femmes: `r format.n(n.femmes75)`
- Sex ratio: `r sex.ratio75`
- Pyramide des âges (âge par année, borne supérieure toujours exclue)
- Par sous classes d’âge:
```{r sous_classe_age, echo=FALSE}
 kable(a)
```

ARRIVÉE
-------

### Horaires de passage

```{r passages75, echo=FALSE}
# vecteur des ENTREES
e <- datetime(pop75$ENTREE)
# extraction de la partie horaire
he <- horaire(e)
# Nb de passages et % en foction de l'horaire
nuit <- passage(he, "nuit")
nuit.profonde <- passage(he, "nuit profonde")
jour <- passage(he, "jour")
```
```{r pds75, echo=FALSE, cache=TRUE}

# Résultat sauvegardé pour tout 2014 dans horaires_pds.Rda; on peut récupérer avec load("horaires_pds.Rda") sous le nom de h.pds puis d'en faire une colonne supplémentaire: dx$HPDS <- h.pds

s.pds <- summary(as.factor(pop75$HPDS))
n.pds <- s.pds["PDSS"]+ s.pds["PDSWE"]# nb RPU en PDS = PDS semaine + pds WE
p.pds <- n.pds * 100 / n.rpu75

s.entree <- summary.entree(as.Date(pop75$ENTREE))

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- Nb de RPU avec date/heure d'entrée renseignés: `r format.n(s.entree['n'])`
- %  passages la nuit: `r nuit[2]*100` % (N = `r format.n(nuit[1])`)
- %  passages en horaire de PDS: `r p.pds` % (N = `r format.n(n.pds)`)

### Moyens de transport

```{r moyen_transport, echo=FALSE}
# moyen de transport utilisé pour se rendre aux urgences

s.transport <- summary.transport(pop75$TRANSPORT)

moy <- summary(as.factor(pop75$TRANSPORT))
n.moy.perso.75 <- as.integer(moy["PERSO"])
p.moy.perso.75 <- n.moy.perso.75 * 100 / n.rpu75 # ne tient pas compte des NA
n.moy.smur.75 <- as.integer(moy["SMUR"])
p.moy.smur.75 <- n.moy.smur.75 * 100 / n.rpu75 # ne tient pas compte des NA
n.moy.vsab.75 <- as.integer(moy["VSAB"])
p.moy.vsab.75 <- n.moy.vsab.75 * 100 / n.rpu75 # ne tient pas compte des NA
n.moy.ambu.75 <- as.integer(moy["AMBU"])
p.moy.ambu.75 <- n.moy.ambu.75 * 100 / n.rpu75 # ne tient pas compte des NA
n.moy.na.75 <- as.integer(moy["NA's"])
p.moy.na.75 <- n.moy.na.75 * 100 / n.rpu75 # ne tient pas compte des NA

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- nombre de moyens de transport: `r s.transport["n"]`
- nombre de moyens de transport renseignés: `r format(s.transport["n"]-s.transport["n.na"])`
- nombre de moyens personnels: `r s.transport["PERSO"]`
- nombre de SMUR: `r s.transport["SMUR"]`
- nombre de VSAV: `r s.transport["VSAB"]`
- nombre d'ambulances privées: `r s.transport["AMBU"]`

- %  d’arrivées Moyen perso: `r p.moy.perso.75` % (N = `r format.n(n.moy.perso.75)`)
- %  d'arrivées SMUR: `r p.moy.smur.75` % (N = `r format.n(n.moy.smur.75)`)
- %  d'arrivées VSAV: `r p.moy.vsab.75` % (N = `r format.n(n.moy.vsab.75)`)
- %  d'arrivées ambulance privée: `r p.moy.ambu.75` % (N = `r format.n(n.moy.ambu.75)`)
- % réponses manquantes: 

NB : commentaire possible pour expliquer que la somme des 4 pourcentages ci dessus ne fait pas 100 % 

### Gravité

```{r gravite75, echo=FALSE}
ccmu75 <- summary(as.factor(pop75$GRAVITE))
n.ccmu75.1 <- ccmu75[1]
n.ccmu75.45 <- sum(ccmu75[4:5])
p.ccmu75.1 <- n.ccmu75.1 * 100 / n.rpu75
p.ccmu75.45 <- n.ccmu75.45 * 100 / n.rpu75

ccmu75 <- summary.ccmu(pop75$GRAVITE)


#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- Nombre de RPU avec une CCMU renseignée: `r format(ccmu75["n"] - ccmu75["n.na"])`
- %  CCMU 1: `r p.ccmu75.1` % (N = `r format.n(n.ccmu75.1)`)
- %  CCMU 4 et 5: `r p.ccmu75.45` % (N = `r format.n(n.ccmu75.45)`)

### Diagnostic principal

- % Médico-chirurgical, dont :
    - % cardio vasculaire
    - % neuro
    - % digestif
    - % respiratoire
- %  Traumatologique
- %  Psychiatrique
- %  Toxicologique
- %  Autres recours

### DURÉE

```{r duree_passage_75, echo=FALSE}
# a mutualiser avec le paragraphe ligne 331
passages75 <- pop75[, c("ENTREE", "SORTIE","MODE_SORTIE")] # dataframe entrées-sorties
passages75 <- passages75[complete.cases(passages75),] # on ne conserve que les couples complets
n.passages75 <- nrow(passages75)
e <- ymd_hms(passages75$ENTREE) # vecteur des entrées
s <- ymd_hms(passages75$SORTIE)
d <- as.numeric((s-e)/60) # vecteur des durées de passage en minutes

# on ne garde que les durées > 0 et < ou = 48 heures
duree75 <- d[d > 0 & d < 2 * 24 * 60 + 1]
n.duree75 <- length(duree75) # nb total de durées
s.duree75 <- summary(duree75) # résumé des durées totales de passage
mean.duree75 <- s.duree75['Mean']
median.duree75 <- s.duree75['Median']
sd.duree75 <- sd(duree75)

# nb de passages dont la durée est supérieure à 4 heures:
duree75.sup.4h <- duree75[duree75 > 4 * 60] # vecteur des durées sup 4 h
n.duree75.sup.4h <- length(duree75.sup.4h) # nb de passages > 4h
p.duree75.sup.4h <- n.duree75.sup.4h / n.duree75

# nb de passages dont la durée est inférieure à 4 heures:
n.duree75.inf.4h <- n.duree75 - n.duree75.sup.4h
p.duree75.inf.4h <- n.duree75.inf.4h / n.duree75

iqr.duree75 <- s.duree75['3rd Qu.'] - s.duree75['1st Qu.']

#durée de passage selon le devenir
e <- ymd_hms(passages75$ENTREE) # vecteur des entrées
s <- ymd_hms(passages75$SORTIE)
passages75$duree <- as.numeric((s-e)/60) # vecteur des durées de passage en minutes

# on ne garde que les durées > 0 et < ou = 48 heures
passages75 <- passages75[passages75$duree > 0 & passages75$duree < 2 * 24 * 60 + 1,]
tapply(passages75$duree, passages75$MODE_SORTIE, mean)
tapply(passages75$duree, passages75$MODE_SORTIE, median)

# on regroupe mutation et transfert
passages75$DEVENIR <- as.character(passages75$MODE_SORTIE)
passages75$DEVENIR[passages75$DEVENIR %in% c("Mutation","Transfert")] <-  "Hosp"
median.devenir75 <- tapply(passages75$duree, passages75$DEVENIR, median)
mean.devenir75 <- tapply(passages75$duree, passages75$DEVENIR, mean)

t <- t.test(passages75$duree ~ passages75$DEVENIR)
t
t$p.value

boxplot(passages75$duree ~ passages75$DEVENIR, outline = FALSE, ylab = "Durée de passage (mn)", main = "Durée de passage selon le devenir (age > 75 ans)")
text(1.5,500,"p < 0.001", cex = 0.8, col = "red")

# routine summary.passages
dp75 <- duree.passage2(pop75)
s.dp75 <- summary.passages(dp75)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- Durée moyenne de passage (HORS UHCD) : `r mean.duree75` minutes
- Durée médiane de passage (HORS UHCD) : `r median.duree75` minutes
- %  de passages de moins de 4h : `r p.duree75.inf.4h * 100` %
- lors d’une hospitalisation post-urgences (hospitalisation = mutation + transfert): `r mean.devenir75["Hosp"]` minutes.
- lors d’un retour au domicile: `r mean.devenir75["Domicile"]` minutes.

#### Nouveau
- Nombre de RPU avec une heure de sortie conforme (]0-72h[: `r s.dp75['n.conforme']`
- Durée moyenne de passage (en min): `r s.dp75['duree.moyenne.passage']` mn
- Durée médiane de passage (en min): `r s.dp75['duree.mediane.passage']` mn
- Nombre de RPU dont la durée de passage est inférieure à 4h: `r s.dp75['n.passage4']`

- Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'une hospitalisation post-urgences: `r s.dp75['n.hosp']`

- Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'un retour au domicile: `r s.dp75['n.dom']`

- Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une hospitalisation post-urgences: `r s.dp75['n.hosp.passage4']`

- Nombre de RPU dont la durée de passage est inférieure à 4h lors d'un retour au domicile: `r s.dp75['n.dom.passage4']`

### MODE DE SORTIE

```{r sortie75, echo=FALSE}
sortie75 <- summary(as.factor(pop75$MODE_SORTIE))

n.hosp.75 <- sum(sortie75["Mutation"],sortie75["Transfert"])
n.mut.75 <- as.integer(sortie75["Mutation"])
n.trans.75 <- as.integer(sortie75["Transfert"])
n.na.sortie.75 <- as.integer(sortie75["NA's"])
n.dom.75 <- as.integer(sortie75["Domicile"])

p.hosp.75 <- n.hosp.75 * 100 / n.rpu75
p.mut.75 <- n.mut.75 * 100 / n.rpu75
p.trans.75 <- n.trans.75 * 100 / n.rpu75
p.dom.75 <- n.dom.75 * 100 / n.rpu75

tab1(pop75$MODE_SORTIE, sort.group = "decreasing", cex = 0.6, cex.names = 0.8, main = "Mode de sortie et Age sup.ou égal à 75 ans")

# nouvelle fonction
mode.sortie.75 <- summary.mode.sortie(pop75$MODE_SORTIE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- %  d’hospitalisation: `r p.hosp.75` % (N = `r format.n(n.hosp.75)`)
    - % de mutation:`r p.mut.75` % (N = `r format.n(n.mut.75)`)
    - % de transfert:`r p.trans.75` % (N = `r format.n(n.trans.75)`)
- %  de retour à domicile:`r p.dom.75` % (N = `r format.n(n.dom.75)`)

#### rapport régional

- Nombre de RPU avec un mode de sortie renseigné: `r format.n(mode.sortie.75['n'] - mode.sortie.75['n.na'])`
- Nombre de mutation interne: `r format.n(mode.sortie.75['n.mutation'])`
- Nombre de transfert externe: `r format.n(mode.sortie.75['n.transfert'])`
- nombre de retours à domicile: `r format.n(mode.sortie.75['n.dom'])`


Les chiffres clés de l’activité AVC des services d’urgences
===========================================================

```{r init_avc, echo=FALSE}
load("../../../Stat Resural/Codes_regroupement_ORUMIP/d3.Rda") # fichier mergé d3
# ajout d'une colonne durée de passage. Nécessite la librairie passage.R
source('~/Documents/Stat Resural/RPU_2014/Analyse/Temps_passage/passage.R')# pour MAC
d3$DPAS <- duree.passage(d3$ENTREE, d3$SORTIE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

```{r dataframe _avc, echo=FALSE}
# d3 est le chier résultant du merging de d14 (2014) et du fichier des codes de regroupement de la Fedoru. Le temps de calcul étant très long, d3 est précalculé. Voir le dossier CODES DE REGROUPEMENT dans Stat Resural.
AVC<-d3[substr(d3$DP,1,3)>="I60" & substr(d3$DP,1,3)<"I65" | substr(d3$DP,1,3)=="G46" | substr(d3$DP,1,3)=="G45" ,]
AVC$etiologie <- NA
AVC$etiologie[substr(AVC$DP,1,3) %in% c("I60","I61","I62")] <-"HEMO"
AVC$etiologie[substr(AVC$DP,1,3) %in% c("I63","I64")] <-"ISCH"
AVC$etiologie[substr(AVC$DP,1,3) %in% c("I64")] <-"NPRE"
AVC$etiologie[substr(AVC$DP,1,3) %in% c("G45","G46")] <-"AIT"
AVC$etiologie <- as.factor(AVC$etiologie)

n.avc <- nrow(AVC)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
RECUEIL DES DONNÉES
-------------------

- Nombre d’AVC dans l'année (+ rappeler le pourcentage d’exhaustivité du DP par rapport au nombre de RPU): __`r format.n(n.avc)`__
- Moyenne quotidienne d’AVC: __`r format.n(n.avc/365)` AVC/j__
- %  d’AVC dans l’activité globale: __`r n.avc *100 / nrow(d3)` %__

Répartition des AVC
-------------------
Exemple d'utilisation de la méthode _hist_ appliquée aux objets date-time:

- _x_ = as.Date(AVC$ENTREE)
- _breaks_ est obligatoire: "days", "weeks", "months", "quarters", "years", "secs", "mins", "hours". Utiliser _start.on.monday = TRUE_ si _breaks = "weeks"_.
- _freq_ = TRUE (défaut FALSE) pour afficher les fréquences
- _format_ permet de coisir l'affichage de la date sur l'axe des x [voir](https://stat.ethz.ch/R-manual/R-devel/library/base/html/strptime.html).


```{r hist_avc}
hist(as.Date(AVC$ENTREE), breaks = "months", freq = TRUE, xlab = "Mois", ylab = "Fréquence", main = "Histogramme des AVC vu en SU en 2014", las = 2, col = "cornflowerblue", border = "white")

```


PATIENTS
--------
```{r patients, echo=FALSE}
avc.sexe <- summary.sexe(AVC$SEXE)
avc.age <- summary.age(AVC$AGE)

s.sexe <- summary(AVC$SEXE)
sr <- avc.sexe['sex.ratio']
avc.h <- avc.sexe['n.hommes']
avc.f <- avc.sexe['n.femmes']

avc.age.renseigne <- avc.age['n.rens']
mean.age <- mean(AVC$AGE)

# découpage INSEE
c.age <- cut(AVC$AGE,breaks = seq(0,120,5), right = FALSE)
table(c.age)
barplot(table(c.age), las = 2, cex.names = 0.8, main = "Histogramme des AVC (découpage INSEE)")

# Découpage FEDORU
c.age <- cut(AVC$AGE,breaks = c(0, 1, 5, 10, 15, 18, 30, 45, 65, 75, 85, 120), right = FALSE)
table(c.age)
barplot(table(c.age), las = 2, cex.names = 0.8, main = "Histogramme des AVC (découpage FEDORU)", col = "cornflowerblue")

# pyramide des ages
avc.pyramide1 <- cut(AVC$AGE, seq(from = 0,to = 120, by = 1), include.lowest = TRUE, right = FALSE)
#table(a)
write.csv(table(avc.pyramide1), file = "avc.pyramide1.csv")

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Sex ratio: `r sr`
- Age moyen: `r round(mean.age, 2)` ans
- Nombre d’AVC par sous classe d’âge (GT1):

ARRIVÉE
--------
- Nombre d’AVC et % par tranche d’heure GT1 (matinée, début d’après midi, fin d’après midi, soirée, nuit profonde)
```{r avc_periode}
# heures de découpage
p <- c(0, 8, 12, 16, 20, 24)
# légende
np <- c("nuit profonde", "matinée", "début après-midi", "fin après-midi", "soirée")
# extraction des heures à partir du format datetime (http://stackoverflow.com/questions/19292438/split-date-time)
a <- as.numeric(format(as.POSIXct(AVC$ENTREE), "%H"))

x <- cut(a, p, np, right = FALSE)
x2 <- cut(a, p, right = FALSE)

rbind(levels(x2), table(x))

avc.pds <- tab1(x, cex.names = 0.8, main = "Heure d'admission des AVC", bar.values = "percent", ylab = "%")

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- % AVC le matin: `r avc.pds$output.table[2,2]` %.
- % AVC en début d'après-midi: `r avc.pds$output.table[3,2]` %.
- % AVC en fin d'après-midi: `r avc.pds$output.table[4,2]` %.
- % AVC en soirée: `r avc.pds$output.table[5,2]` %.
- % AVC le nuit profonde: `r avc.pds$output.table[1,2]` %.

- Nombre de passages AVC urgences, déclinaison par département, établissement, année N
```{r avc_finess}
tapply(as.Date(AVC$ENTREE), AVC$FINESS, length)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```


- %  passages en horaire de PDS

```{r avc_pds, echo=FALSE}
s.avc.pds <- summary(as.factor(AVC$HPDS))
# s.avc.pds
p.avc.pds <- round(prop.table(s.avc.pds) * 100, 2)
# p.avc.pds
a <- rbind(s.avc.pds, p.avc.pds)
n <- colnames(a)
n[3] <- "NPDS"
colnames(a) <- n
rownames(a) <- c("Nombre AVC", "% AVC")
kable(a)

# Résumé de la qualité des horaires AVC
s.dateHeure <- summary.dateheure(AVC$ENTREE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

PDSS = horaires de PDS en semaine, PDSWE = horaires de PDS le WE, NPDS = hors horaire de PDS.

- nombre d'AVC aux horaires de PDS en semaine: `r a[2,1]` %
- nombre d'AVC aux horaires de PDS de week-end:`r a[2,2]` %
- nombre d'AVC en dehors des horaires de PDS:`r a[2,3]` %
- Nombre de RPU avec diag AVC avec date et heure d'entrées renseignées: `r format.n(s.dateHeure['n.rens'])`

Mode d'arrivée aux urgences
---------------------------

```{r avc_transport, echo=FALSE}
n.avc.moyen <- summary(factor(AVC$TRANSPORT))
# n.avc.moyen
p.avc.moyen <- round(prop.table(n.avc.moyen)*100, 2)
# p.avc.moyen

# nuvelle fonction
s.avc.transport <- summary.transport(AVC$TRANSPORT)
s.avc.transport

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- Nombre de RPU avec moyens de transport précisé: `r format.n(s.avc.transport['n.rens'])`
- %  d’arrivées Moyen perso: `r p.avc.moyen["PERSO"]`%
- %  d'arrivées SMUR: `r p.avc.moyen["SMUR"]`%
- %  d'arrivées VSAV: `r p.avc.moyen["VSAV"]`%
- %  d'arrivées ambulance privée: `r p.avc.moyen["AMBU"]`%
NB : commentaire possible pour expliquer que la somme des 4 pourcentages ci dessus ne fait pas 100 %

Diagnostic principal
--------------------

```{r diag_principal}
t.diag <- table(AVC$etiologie)
p.diag <- prop.table(t.diag)*100
dp.avc <- rbind(t.diag, p.diag)
rownames(dp.avc) <- c("nombre","%")

# Exhaustivité CCMU 
dp.corrigee <- dx$DP[!(dx$ORIENTATION %in% c("FUGUE","PSA","REO"))] # on ne tient pas compte des RPU dont le motif ORIENTATION = fugue, reo ou psa
n.dp.utilisable <- length(dp.corrigee)
n.dp.conforme <- sum(!is.na(dp.corrigee)) # Nombre de RPU 2014 hors orientation = FUGUE, PSA et REO ayant un élément transmis pour la CCMU

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- Nombre d’AVC ischémiques et %: `r format.n(dp.avc[1,3])` (`r dp.avc[2,3]` %)
- Nombre d’AVC hémorragiques et %: `r format.n(dp.avc[1,2])` (`r dp.avc[2,2]` %)
- Nombre d’AIT et %: `r format.n(dp.avc[1,1])` (`r dp.avc[2,1]` %)
- Nombre de codes "symptomatiques" (hémiplégie, aphasie, amaurose, etc…) et %: `r format.n(dp.avc[1,4])` (`r dp.avc[2,4]` %)

NB : se référer à l’annexe 4 pour les regroupements.

DURÉE
-----
Voir ligne 333

Voir les routines de RPU_2014/Analyse/Temps_passage/passage.R et notamment __temps de passage__.

```{r avc_passage}
source('~/Documents/Stat Resural/RPU_2014/Analyse/Temps_passage/passage.R')# pour MAC
# on ne garde que les durées de passage non nulles et < 48H
ts.avc <- AVC[!is.na(AVC$DPAS) & AVC$DPAS > 0 & AVC$DPAS <= 2*24*60, "DPAS"]
mean.ts.avc <- mean(as.numeric(ts.avc))
median.ts.avc <- median(as.numeric(ts.avc))
n.ts.avc.inf4h <- length(ts.avc < 4 * 60) # nombre AVC restés moins de 4 heures aux urgences
p.ts.avc.inf4h <- n.ts.avc.inf4h / nrow(AVC)

# nouvelles routines
dp.avc <- duree.passage2(AVC)
s.dp.avc <- summary.passages(dp.avc)


#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Nombre de RPU avec une heure de sortie conforme (]0-72h[: `r format.n(s.dp.avc['n.conforme'])`
- Durée moyenne de passage des patients PEC pour AVC (en min): `r format.n(s.dp.avc['duree.moyenne.passage'])`
- Durée médiane de passage des patients PEC pour AVC (en min): `r format.n(s.dp.avc['duree.mediane.passage'])`
- Nombre de RPU ac diag AVC dont la durée de passage est inférieure à 4h: `r format.n(s.dp.avc['n.passage4'])`

- Durée de passage (HORS UHCD) année N: moyenne __`r mean.ts.avc`__ minutes, et médiane __`r median.ts.avc`__ minutes.
- % de passages de moins de 4h `r p.ts.avc.inf4h`


MODE DE SORTIE
--------------
```{r avc_mode_sortie}
avc.sortie <- tab1(factor(AVC$MODE_SORTIE), main = "AVC - Mode de sortie")
s.sortie <- summary.mode.sortie(AVC$MODE_SORTIE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Nombre de RPU ac diag. AVC avec un mode de sortie renseigné: `r s.sortie['n.rens']`
- % d’hospitalisation: `r avc.sortie$output.table[1,3] + avc.sortie$output.table[2,3]` % (N = `r s.sortie['n.hosp']`)
- % de mutation: `r avc.sortie$output.table[1,3]` % (N = `r s.sortie['n.mutation']`)
- % de transfert: `r avc.sortie$output.table[2,3]` % (N = `r s.sortie['n.transfert']`)
- % de retour à domicile: `r avc.sortie$output.table[3,3]` % (N = `r s.sortie['n.dom']`)

Orientation
----------
- Répartition par orientation en pourcentage, année N

```{r avc_orientation}
s.avc <- summary(factor(AVC$ORIENTATION))
avc.chir <- s.avc['CHIR']
avc.fugue <- s.avc['FUGUE']
avc.hdt <- s.avc['HDT']
avc.ho <- s.avc['HO']
avc.med <- s.avc['MED']
avc.obst <- s.avc['OBST']
avc.psa <- s.avc['PSA']
avc.rea <- s.avc['REA']
avc.reo <- s.avc['REO']
avc.sc <- s.avc['SC']
avc.scam <- s.avc['SCAM']
avc.si <- s.avc['SI']
avc.uhcd <- s.avc['UHCD']
avc.na <- s.avc["NA's"]

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

```{r star_orientation, echo=FALSE, results='asis', comment=FALSE}
stargazer(s.avc, title = "Orientation des AVC", label = "orientation")

```

Analyse par type d'étblissement
===============================

SU de CHU
---------

Un seul établissement __HUS__ avec 3 SU:

- NHC
- HTP Adultes
- HTP Pédiatrie

```{r chu, echo=FALSE}
es <- dx[dx$FINESS == "Hus",]
#analyse_type_etablissement(es)

# nombre de passages déclarés
    nrow(es)
    # Nombre de RPU avec un âge renseigné
    summary.age(es$AGE)
    # Nombre de RPU avec un code postal renseigné
    summary.cp(es$CODE_POSTAL)
    
    # par jour de semaine
    summary.wday(es$ENTREE)
    summary.age(es$AGE)
    # passages de nuit
    passage(horaire(es$ENTREE), "nuit")
    # passage en PDS
    table(pds(es$ENTREE))
    #Nombre de RPU avec une date et heure d'entrée renseignées
    summary.dateheure(es$ENTREE)
    # nombre avec moyen de transport renseigné
    summary.transport(es$TRANSPORT)
    # nombre avec CCMU renseigné
    summary.ccmu(es$GRAVITE)
    # nombre de sorties conformes
    summary.passages(duree.passage2(es))
    # Nombre de RPU avec un mode de sortie renseigné
    summary.mode.sortie(es$MODE_SORTIE)
```

SU d'ES siège de SAMU, non CHU
------------------------------

Un seul établissement: CH de Mulhouse avec 2 implantations:

- Emile Muller (Adultes + Pédiatrie traumatique)
- Hasenrain (Pédiatrie médicale)

```{r mul, echo=FALSE, comment=""}
es <- dx[dx$FINESS == "Mul",]
# analyse_type_etablissement(es)

    # nombre de passages déclarés
    nrow(es)
    # Nombre de RPU avec un âge renseigné
    summary.age(es$AGE)
    # Nombre de RPU avec un code postal renseigné
    summary.cp(es$CODE_POSTAL)
    
    # par jour de semaine
    summary.wday(es$ENTREE)
    summary.age(es$AGE)
    # passages de nuit
    passage(horaire(es$ENTREE), "nuit")
    # passage en PDS
    table(pds(es$ENTREE))
    #Nombre de RPU avec une date et heure d'entrée renseignées
    summary.dateheure(es$ENTREE)
    # nombre avec moyen de transport renseigné
    summary.transport(es$TRANSPORT)
    # nombre avec CCMU renseigné
    summary.ccmu(es$GRAVITE)
    # nombre de sorties conformes
    summary.passages(duree.passage2(es))
    # Nombre de RPU avec un mode de sortie renseigné
    summary.mode.sortie(es$MODE_SORTIE)
```

SU avec SMUR non siège de SAMU
------------------------------

SU abec SMUR sans SAMU, 5 établissements:

- CH Wissembourg
- CH haguenau
- CH Saverne
- CH Sélestat
- CH Colmar

```{r sus, echo=FALSE, comment=""}
es <- dx[dx$FINESS %in% c("Wis","Hag","Sav","Sel","Col"),]
# analyse_type_etablissement(es)

# nombre de passages déclarés
    nrow(es)
    # Nombre de RPU avec un âge renseigné
    summary.age(es$AGE)
    # Nombre de RPU avec un code postal renseigné
    summary.cp(es$CODE_POSTAL)
    
    # par jour de semaine
    summary.wday(es$ENTREE)
    summary.age(es$AGE)
    # passages de nuit
    passage(horaire(es$ENTREE), "nuit")
    # passage en PDS
    table(pds(es$ENTREE))
    #Nombre de RPU avec une date et heure d'entrée renseignées
    summary.dateheure(es$ENTREE)
    # nombre avec moyen de transport renseigné
    summary.transport(es$TRANSPORT)
    # nombre avec CCMU renseigné
    summary.ccmu(es$GRAVITE)
    # nombre de sorties conformes
    summary.passages(duree.passage2(es))
    # Nombre de RPU avec un mode de sortie renseigné
    summary.mode.sortie(es$MODE_SORTIE)
```


SU non SMUR, non SAMU, non CHU
------------------------------

ES avec SU isolé (pas de SMUR associé): 8 établissements

- Ste Anne
- Ste Odile
- Diaconat Strasbourg
- CH de Guebwiller
- CH de Thann (pas de RPU)
- CH d'Altkirch
- Clinique des 3 frontières
- Roosvelt
- Fonderie

```{r esnsns, echo=FALSE, comment=""}
es <- dx[dx$FINESS  %in% c("Ane","Odi","Dts","Geb","Alk","3Fr","Ros","Dia"),]

# nombre de passages déclarés
nrow(es)
# Nombre de RPU avec un âge renseigné
summary.age(es$AGE)
# Nombre de RPU avec un code postal renseigné
summary.cp(es$CODE_POSTAL)

# par jour de semaine
summary.wday(es$ENTREE)
summary.age(es$AGE)
# passages de nuit
passage(horaire(es$ENTREE), "nuit")
# passage en PDS
table(pds(es$ENTREE))
#Nombre de RPU avec une date et heure d'entrée renseignées
summary.dateheure(es$ENTREE)
# nombre avec moyen de transport renseigné
summary.transport(es$TRANSPORT)
# nombre avec CCMU renseigné
summary.ccmu(es$GRAVITE)
# nombre de sorties conformes
summary.passages(duree.passage2(es))
# Nombre de RPU avec un mode de sortie renseigné
summary.mode.sortie(es$MODE_SORTIE)

```

Doublons ?
----------

- Age moyen, année N
- Répartition par classe âge en pourcentage, année N
- Répartition par sexe en pourcentage, année N
- TOP 5 pourcentage par code CIM 10, année N
- Répartition we/semaine en pourcentage, année N
- Répartition par tranche heure en pourcentage, année N

```{r enregistre_chiffres, echo=FALSE}
write.csv(chiffres, row.names = names(chiffres), file = paste("chiffres_", anc, ".csv", sep = ""))
```


ANNEXES
=======

ANNEXE 1 : Définitions
----------------------

ANNEXE 2 : Diagramme de complétude des RPU
------------------------------------------

ANNEXE 3 : Calcul du TARRU
--------------------------

Information de session
======================

```{r session, echo=FALSE, comment=""}
sessionInfo()

citation()
```