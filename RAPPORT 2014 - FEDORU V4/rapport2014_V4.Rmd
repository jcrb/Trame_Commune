---
title: 'Activité des structures d’urgences : panorama 2014 de la région ALSACE'
author: "RESURAL (JcB)"
date: "28/01/2015"
output:
  pdf_document:
    fig_height: 4
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
  html_document:
    highlight: pygments
    keep_md: yes
    number_sections: yes
    theme: cerulean
    toc: yes
graphics: yes
---

Version mse à jour le: __`r format(Sys.Date(), "%d/%m/%Y")`__

```{r titre, echo=FALSE}
anc <- 2014 # année courante
anp <- 2013 # année précédente
xtable.type <- "latex"
```

```{r Declarations, echo=FALSE, include=FALSE}
library(knitr)
options(scipen = 6, digits = 2)
ptm <- proc.time() # chronométrage
library(lubridate)
library(plotrix) # radialplot et pyramid.plot
library(xts)
library(R.utils)
library(epicalc)
library(stargazer)
library(sp)
library(png)
library(xtable)
options(xtable.comment = FALSE)

# set global chunk options
opts_chunk$set(echo = FALSE, cache=FALSE, warning=FALSE, message = FALSE, tidy=FALSE, fig.width=8, fig.height=6, scipen= 6, digits = 2)
```


```{r prerequis, echo=FALSE, comment="", message=FALSE}
# Quelle est la machine active ?
host <- System$getHostname()
if(host == "MacBook-Air-de-JCB.local" | host == "Air-de-JCB"){
    path <- "../../../Stat Resural/RPU_2014/"
    source("../../../Stat Resural/RPU_Doc/mes_constantes.R")
    # en mode console:
    # path <- "../../Stat Resural/RPU_2014/"
    # source("../../Stat Resural/RPU_Doc/mes_constantes.R")
    
    load("~/Documents/Stat Resural/Codes_regroupement_ORUMIP/d3.Rda") # d3 contient les données mergées
    source('~/Documents/Stat Resural/Codes_regroupement_ORUMIP/regroupement.R')
    
    load("../../../Stat Resural/Codes_regroupement_ORUMIP/d3.Rda") # fichier mergé d3
    # ajout d'une colonne durée de passage. Nécessite la librairie passage.R
    source('~/Documents/Stat Resural/RPU_2014/Analyse/Temps_passage/passage.R')# pour MAC
    sae <- read.csv("../../../Stat Resural/RPU_Doc/mes_constantes2_sae.csv")
    
}else if(host == "XPS"){#XPS
    
    path <- "../../../Stat Resural/RPU_2014/"
    sae <- read.csv("../../../Stat Resural/RPU_Doc/mes_constantes2_sae.csv")
    source("../../../Stat Resural/RPU_Doc/mes_constantes.R")
      load("../../Codes_regroupement_ORUMIP/Analyse_regroupements/d3.Rda") # d3 contient les données mergées
    source("../../Codes_regroupement_ORUMIP/Analyse_regroupements/regroupement.R")
    source('../../../Stat Resural/RPU_2014/Analyse/Temps_passage/passage.R')
    
}else if(host == "P171I16"){# HUS
    path <- "../RPU_2014-master/"}

source('../Rapport/rapport_2014.R') # routines pour le rapport d'activité
# en mode console source('Rapport/rapport_2014.R')

test <- 0 # TRUE = Janvier 2015

if(test == 0){
    file <- "rpu2014d0112_c2.Rda" # données de 2014
    load(paste0(path, file))
    dx <- d14 # si file actif
    rm(d14)
}else{
    file <- "rpu2015d01.Rda" # fichier de test
    load(paste0(path, file))
    dx <- d01 
    rm(d01)
}

#source(paste0(path, "RPU_Doc/mes_constantes.R"))

n.rpu <- nrow(dx) # nb de passages dans l'année

# RPU corrigés: on retire les RPU où l'orientation est égale à "FUGUE","PSA","REO"
# sous forme de dataframe:
# dx.corrigee <- dx[!(dx$ORIENTATION %in% c("FUGUE","PSA","REO")),]
# nrow(dx.corrigee)
# sous forme de vecteur
dx.corrigee2 <- dx[!(dx$ORIENTATION %in% c("FUGUE","PSA","REO")),1]
n.rpu.corriges <- length(dx.corrigee2)

# Le document de référence pour le rapport est: __V4 trame commune 2014 rapport inter région__ (xps: /home/jcb/Documents/Resural/FEDORU/Trame_Commune/DOC/Trame commune 2014 rapport inter région (V4).docx)
# 
# __NOTE__: certaines informations utiles sont dans __RPU_Doc__.
```

Activité des structures d’urgences : panorama `r anc` de la région ALSACE
=========================================================================
Chiffres clés `r anc` respectant les préconisations de la FEDORU. Source:
[Trame commune](https://docs.google.com/document/d/101LYVqVLeHZnrujfMm3aqBYfbOwx3CPEB3Y-Lbud2Ls/edit).
Ce document n'est pas validé et est à considérer comme un document de travail.



LE MOT DU PRÉSIDENT DE LA FEDORU
================================

```{r test, child = '../mot_du_president_2014.Rmd'}
```

Le contexte régional
====================

```{r contexte, child = '3-Contexte/contexte.Rmd'}
```

Description de l’offre de soins
===============================

```{r samu_smur_su, fig.height=12, fig.align='center'}

# Carte des SU d'Alsace

# library(sp)
# library(png)

par(mar = c(0,0,2,0))

# carte de l'Alsace avec les villes sièges de SU
load("../../../Stat Resural/RPU_Doc/RPU_Carto-Pop-Alsace/Cartographie/Cartofile/als_ts.Rda") #ctss
plot(ctss, main = "Structures d'urgences en Alsace")
load("../../../Stat Resural/RPU_Doc/RPU_Carto-Pop-Alsace/Cartographie/Cartofile/tsvilles.Rda")
points(tsvilles[,2]*100,tsvilles[,3]*100,pch=20,col="red", cex = 1.2)
text(tsvilles[,2]*100,tsvilles[,3]*100,tsvilles[,1],cex=0.8,pos=4)
box()

# SMUR
smur <- tsvilles[tsvilles$NOM %in% c('WISSEMBOURG','HAGUENAU','SAVERNE','STRASBOURG','SELESTAT','COLMAR','MULHOUSE'),]
a.smur <- as.raster(readPNG("../Logos/data/ambulance15(14).png"))
cx <- 6000 # coefficient d'aggrandissement (n = 9000)
x <- smur[,2]*100
y <- smur[,3]*100
dpy <- 600 # déplacement de y (une valeur positive déplace vers le haut)
dpx <- 0 # déplacement horizontal
rasterImage(a.smur, x, y + dpy, x + cx, y + dpy + cx) # img, x1, y1, x2, y2

# SAMU
samu <- tsvilles[tsvilles$NOM %in% c('STRASBOURG', 'MULHOUSE'),]
a.samu <- as.raster(readPNG("../Logos/data/customer(3).png"))
rasterImage(a.samu, samu[,2]*100 - 10000, samu[,3]*100, samu[,2]*100 - 10000 + 10000, samu[,3]*100 + 10000)

# hélismur
a.heli <- as.raster(readPNG("../Logos/data/chopper5(7).png"))
x <- samu[,2]*100
y <- samu[,3]*100
cx <- 15000
dpx <- 8000
dpy <- 12000
rasterImage(a.heli, x - dpx, y - dpy, x - dpx + cx, y + cx - dpy )

# légende
x <- 1037503 + 20000
y <- 6810919 - 10000

rasterImage(a.samu, x, y, x + 10000, y + 10000)
text(x + 10000, y + 5000, "SAMU", pos=4)

x <- x
y <- y - 10000
rasterImage(a.smur, x, y, x + 10000, y + 10000)
text(x + 10000, y + 5000, "SMUR", pos=4)

library(graphics) # cercle
x <- x + 5000
y <- y - 5000
symbols(x, y, circles = 1500, bg = "red", add = TRUE, inches = FALSE)
text(x + 8000, y , "SU", pos=4)

x <- x - 5000
y <- y - 12000
rasterImage(a.heli, x, y, x + 10000, y + 10000)
text(x + 10000, y + 5000, "HELISMUR", pos=4)
```



Qualité des données 
-------------------
Réalisation d’un diagramme radar présentant l’exhaustivité des items RPU.

```{r completude, echo = FALSE, fig.width=10}
# calcul de la complétude. La complétude brute est corrigée pour les rubriques orientation et detination.
# comp <- completude(dx[, -c(1,7)]) # on retire les colonnes sans intérêt: id, EXTRACT
# on réordonne les colonnes (ordre FEDORU)
dx2 <- dx[, c("FINESS","id","EXTRACT","CODE_POSTAL","COMMUNE","NAISSANCE","SEXE","ENTREE","MODE_ENTREE","PROVENANCE","TRANSPORT","TRANSPORT_PEC","SORTIE","MODE_SORTIE","DESTINATION","ORIENTATION","MOTIF","GRAVITE","DP")]

comp <- completude(dx2, calcul = "percent")
s.comp <- completude(dx2, calcul = "somme")

rm(dx2)

# barplot
par(mar = c(4,6,3,1))
barplot(sort(comp), horiz = TRUE, las = 1, cex.names = 0.8, xlab = "% de complétude", main = "Complétude des champs RPU", col = "light green")
abline(v = 80, lty = 2, col = "red")
```

```{r radar, echo = FALSE, fig.width=10}
# Tracé du diagrame en étoile
par(mar =c (0,0,0,0))
radar.completude(completude(dx))
```

Complétude en valeur absolue:
```{r, echo=FALSE, comment=""}
s.comp
```
Complétude en pourcentages:
```{r, echo=FALSE, comment=""}
comp
```

Les chiffres clés de l’activité des services d’urgences
=======================================================

Le format des chiffres clés est celui défini par la FEDORU. Il est commun à toutes les régions membres de la FEDORU.

Recueil des données
-------------------
```{r chiffres, echo=FALSE, comment=""}
anc <- 2014    # année courante
anp <- anc - 1 # année précédente
n.rpu <- nrow(dx) # nb de passages dans l'année
n.jours <- length(unique(as.Date(dx$ENTREE))) # nb de jours pour la période

periode.debut <- min(as.Date(dx$ENTREE))
periode.fin <- max(as.Date(dx$ENTREE))

publics <- c("Wis", "Hag", "Sav", "Hus", "Sel", "Geb", "Col", "Tan", "Alk", "Mul", "3Fr")
prives <- c("Odi", "Ane", "Dts", "Ros", "Dia")
n.su <- 16 # nombre de SU
n.su.ped <- 1 # nombre de SU pediatriques
n.su.adultes <- 2 # nombre de SU adultes
n.su.polyvalents <- 13
n.su.publics <- 12
n.su.prives <- 4

mean.rpu.quot <- n.rpu / n.jours # Moyenne quotidienne de passages

#---------------------- Chiffres ---------------------------------------------------------------
chiffres <- c(anc, periode.debut, periode.fin, n.jours, n.su.ped, n.su.adultes, n.su.polyvalents, n.su.publics, n.su.prives, n.rpu, mean.rpu.quot)
names(chiffres) <- c("anc", "periode.debut", "periode.fin", "n.jours", "n.su.ped", "n.su.adultes", "n.su.polyvalents", "n.su.publics", "n.su.prives", "n.rpu", "mean.rpu.quot")
#---------------------- Chiffres end -----------------------------------------------------------

n.sae.2014 <- sum(sae[!(sae$HOP %in% c('Htp','Nhc','Pas','Prc','Emr','Hsr')), paste0("X", anc)], na.rm = TRUE)

```
- Population alsacienne au 1er janvier 2014: `r format.n(pop.als.tot.2014)` [INSEE]()
- Nombre de passages dans l'année: `r format.n(n.sae.2014)` (données SAE 2014)
- Nombre de passages pour 10.000 habitants: `r format.n(round(n.sae.2014*10000/pop.als.tot.2014, 0))`
- Nombre de RPU déclarés: __`r format.n(n.rpu)` RPU__
- Nombre de RPU pour 10.000 habitants: `r format.n(round(n.rpu*10000/pop.als.tot.2014, 0))`
- Exhaustivité du recueil: __`r round(n.rpu * 100 / n.sae.2014, 2)` %__
- Moyenne quotidienne de passages: __`r format.n(mean.rpu.quot)` RPU/jour__
- %(N) d'évolution par rapport à année `r anp`: __`r round(evolution(n.rpu, n.rpu.2013)*100, 0)` %__.
- % d’évolution moyenne sur les 5 dernières années (méthode calcul : _pas de données disponibles_.
- Données renseignées (données à partir desquelles tout le reste de l’analyse sera effectuée) = Nombre de RPU transmis: `r format.n(n.rpu)` RPU
    

Patients
--------
### Sexe
```{r sexe, echo=FALSE, comment=""}
s <- summary.sexe(dx$SEXE)
p.femme <- s["p.femmes"] # % de femmes
p.homme <- s["p.hommes"] # % d'hommes
sex.ratio <- s["sex.ratio"] # sex ratio
n.hommes <- s["n.hommes"]
n.femmes <- s["n.femmes"]
tx.masculinite <- s["tx.masculinité"]
n.sexe.renseigne <- s["n.rens"]
p.sexe.renseigne <- s["p.rens"]

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(p.femme, p.homme, n.femmes, n.hommes, tx.masculinite)
names(val) <- c("p.femme", "p.homme", "n.femmes", "n.hommes", "tx.masculinite")
chiffres <- c(chiffres, val)
#---------------------- Chiffres end -----------------------------------------------------------
```

- %(N) Femme: `r round(p.femme, 2)` % (`r format.n(n.hommes)`)
- %(N) Homme: `r round(p.homme, 2)` % (`r format.n(n.femmes)`)
- Sex ratio: __`r sex.ratio`__
- Taux de masculinité: `r tx.masculinite`

### Age

```{r age, echo=FALSE, comment=""}
s <- summary.age(dx$AGE)

n.inf1an <- s["n.inf1an"]
p.inf1an <- s["p.inf1an"]

n.inf15an <- s["n.inf15ans"]
p.inf15an <- s["p.inf15ans"]

n.inf18an <- s["n.inf18ans"]
p.inf18an <- s["p.inf18ans"]

n.supegal75an <- s["n.75ans"]
p.supegal75an <- s["p.75ans"]

n.supegal80 <- s["n.80ans"]
p.supegal80 <- s["p.80ans"]

n.supegal90 <- s["n.90ans"]
p.supegal90 <- s["p.90ans"]

mean.age <- s["mean.age"]
sd.age <- s["sd.age"]
median.age <- s["median.age"]

# ----------------- Age et sexe ----------------------------
s <- summary.age.sexe(dx)

mean.age.h <- s['mean.age.h'] # age moyen des hommes
mean.age.f <- s['mean.age.f'] # age moyen des femmes

sd.age.sexe <- tapply(dx$AGE, dx$SEXE, sd, na.rm = TRUE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(n.inf1an, n.supegal90, p.inf1an, n.inf15an, p.inf15an, n.inf18an, p.inf18an, n.supegal75an, p.supegal75an, mean.age, sd.age, median.age, mean.age.h, mean.age.f)
names(val) <- c("n.inf1an", "n.supegal90", "p.inf1an", "n.inf18an", "p.inf18an", "n.supegal75an", "p.supegal75an", "mean.age", "sd.age", "median.age", "mean.age.h", "mean.age.f")
chiffres <- c(chiffres, val)

#---------------------- Chiffres end ------------------------------------------------------------
```

- age moyen: __`r round(mean.age, 2)` ans__.
- age moyen des hommes: `r round(mean.age.h, 2)` ans.
- age moyen des femmes: `r round(mean.age.f, 2)` ans.

- % (N) < 1 an: `r format.n(n.inf1an)` (__`r round(100 * p.inf1an, 2)` %__)
- %(N) < 15 ans: `r format.n(n.inf15an)` (__`r round(100 * p.inf15an, 2)` %__)
- %(N) < 18 ans: `r format.n(n.inf18an)` (__`r round(100 * p.inf18an, 2)` %__)
- %(N) >= 75 ans: `r format.n(n.supegal75an)` (__`r round(100 * p.supegal75an, 2)` %__)
- Pyramide des ages:

```{r pyramide, echo=FALSE, message=FALSE}

# par tranche d'age de 5 ans, borne sup exclue: [0-5[ ans
p <- pyramide.age(dx, cut = 5)

#---------------------- Chiffres ---------------------------------------------------------------
#---------------------- Chiffres end -----------------------------------------------------------

```

### Taux de recours (définition FEDORU) régional aux urgences.

Le taux de recours régional est calculé à partir des données de l'INSEE.

```{r tarru, echo=FALSE}
# pop.als.tot.2014 <- 1868773 # chiffre insee au 1/1/2014 (http://www.insee.fr/fr/themes/tableau.asp?reg_id=15&ref_id=poptc02104)
pop.region <- 1868773 # pop.als.tot.2014
tarru <- tarru(dx$CODE_POSTAL, pop.region)

#---------------------- Chiffres ---------------------------------------------------------------
# val <- c(pop.als.tot, residents, tarru)
# names(val) <- c("pop.als.tot", "residents", "TARRU")
# chiffres <- c(chiffres, val)
#---------------------- Chiffres end -----------------------------------------------------------

```

TARRU: __`r tarru`%__ (ref: population alsacienne `r anc`)

### Pourcentage  de Patients ne venant pas de la région (étranger compris)
```{r etrangers, echo=FALSE}
x <- as.character(dx$CODE_POSTAL)
b <- substr(x,1,2)
org_als <- b[b == "67" | b == "68"]
n.org_als <- length(org_als)
p.org_als <- n.org_als / n.rpu

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(n.org_als, p.org_als)
names(val) <- c("nb_alsaciens", "p_alsaciens")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

Part des non résidents: __`r (1 - p.org_als) * 100`%__ (N = `r format.n(n.rpu - n.org_als)`)

ARRIVÉE
-------
```{r horaires_pds, echo=FALSE}
# ajout d'une colonne horaires de PDS
dx$HPDS <- pdsa(dx$ENTREE)
```

### Horaires de passage

```{r horaires, echo=FALSE}
# la plupart des instructions qui suivent ont été transformée en fonctions. Voir rapport2014.R notamment passage(), horaire() et datetime().

#--------------- OLD -------------------------------------------------
# passages <- dx[, c("ENTREE", "SORTIE")] # dataframe entrées-sorties
# passages <- passages[complete.cases(passages),] # on ne conserve que les couples complets
# n.passages <- nrow(passages)
# e <- ymd_hms(passages$ENTREE) # vecteur des entrées
# s <- ymd_hms(passages$SORTIE)
# 
# # horaires seuls. Il faut isoler les heures de la date
# he <- hms(substr(e, 12, 20)) # heures d'entrée
# hs <- hms(substr(s, 12, 20)) # heures de sortie
# 
# # graphique des entrées
# x <- barplot(table(hour(he)), main = paste("Heures d'entrée -", anc), ylab = "Fréquence", xlab = "Heures")
# #x

# passages et durées de passage
dp <- duree.passage2(dx)

# graphique des entrées
x <- barplot(table(hour(dp$he)), main = paste("Heures d'entrée -", anc), ylab = "Fréquence", xlab = "Heures")
# arrivées cumulées
x <- table(hour(dp$he))
s <- cumsum(x/sum(x))
plot(s, type = "l", main = "arrivées cumulées sur 24 heures", ylab = "Pourcentage", xlab = "Heures", xlim = c(0, 24))

# passages de nuit (nécessite lubridate) library(lubridate)
# nombre de passages dont l’admission s’est effectuée sur la période [20h00 - 7h59] divisé par l’ensemble des passages
# en fait sous estime le nombre reel car utilise le couple entree-sortie. Comme il y a moins de sorties, le nombre de couples est plus faible que le nombre d'entrées.

# nuit <- he[he > hms("19:59:59") | he < hms("08:00:00")]
# n.passages.nuit <- length(nuit) # passages 20:00 - 7:59
# p.passages.nuit <- n.passages.nuit / n.passages
passages.nuit <- passages2(dx$ENTREE, "nuit")
n.passages.nuit <- passages.nuit[1]
p.passages.nuit <- passages.nuit[2]

# jour
# jour <- he[he > hms("07:59:59") & he < hms("20:00:00")]
# n.passages.jour <- length(jour)
# p.passages.jour <- n.passages.jour/n.passages
passages.jour <- passages2(dx$ENTREE, "jour")
n.passages.jour <- passages.jour[1]
p.passages.jour <- passages.jour[2]

# passages en nuit profonde
#nombre de passages dont l’admission s’est effectuée sur la période [00h00 - 7h59] divisé par l’ensemble des passages
# nuit.profonde <- he[he < hms("08:00:00")]
# n.passages.nuit.profonde <- length(nuit.profonde)
# p.passages.nuit.profonde <- n.passages.nuit.profonde / n.passages
passages.nuit.profonde <- passages2(dx$ENTREE, "nuit_profonde")
n.passages.nuit.profonde <- passages.nuit.profonde[1]
p.passages.nuit.profonde <- passages.nuit.profonde[2]

#---------------------- Chiffres ---------------------------------------------------------------
# val <- c(n.passages,n.passages.nuit, p.passages.nuit, n.passages.nuit.profonde, p.passages.nuit.profonde)
# names(val) <- c("Passages.48H", "Passages.N", "Passages.NP", "%Passages.N", "%Passages.NP")
# chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Passages de nuit (20h - 8h): __`r round(p.passages.nuit * 100, 2)` %__ (N = `r format.n(n.passages.nuit)`)
- Passages en nuit profonde (0h - 8h): __`r round(p.passages.nuit.profonde * 100, 2)` %__ (N = `r format.n(n.passages.nuit.profonde)`)

```{r passage_pds, echo=FALSE, comment=""}
# utilise le fichier horaires_pds.Rda. Obsolète, remplacé par fonction pds()
# load("~/Documents/RESURAL/Trame_Commune/horaires_pds.Rda")
# s.pds <- summary(as.factor(h.pds))
# p.s.pds <- prop.table(s.pds)

pds <- table(pdsa(dx$ENTREE))
n.pds <- pds["PDSS"] + pds["PDSWE"] # nombre de passages aux horaires de PDS
p.pds <- n.pds / sum(pds) # % de passages aux horaires de PDS

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(p.pds)
names(val) <- c("Passages.PDS")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Passages en horaire de PDSA: __`r p.pds * 100` %__ N = `r format.n(n.pds)` (Remarque: ne tient pas compte des jours fériés survenant en semaine)

### Variations saisonnières
```{r saison, echo=FALSE}
# nombre de passages en juillet-aout
n.rpu.ete <- length(dx[month(as.Date(dx$ENTREE)) %in% c(7, 8), "ENTREE"])
mean.rpu.ete <- n.rpu.ete / 62 # nb moyen de rpu en été

# nb de passages le reste de l'année
n.rpu.autre.mois <- n.rpu - n.rpu.ete
mean.rpu.autre <- n.rpu.autre.mois / 303

# évolution
t <- (mean.rpu.ete - mean.rpu.autre) / mean.rpu.autre
```
Variation du nombre de RPU entre les mois d'été (juillet-août) et les autres mois de l'année: __`r t * 100` %__.

### Moyens d'arrivée

```{r transpport, echo=FALSE, comment=""}
s <- summary.transport(dx$TRANSPORT)
n.transport <- s['n.rens'] # nb de moyens de transport renseignés
n.transport.perso <- s['n.perso']
p.transport.perso <- n.transport.perso / n.transport
n.transport.ambu <- s['n.ambu']
p.transport.ambu <- n.transport.ambu / n.transport
n.transport.fo <- s['n.fo']
p.transport.fo <- n.transport.fo / n.transport
n.transport.heli <- s['n.heli']
p.transport.heli <- n.transport.heli / n.transport
n.transport.smur <- s['n.smur']
p.transport.smur <- n.transport.smur / n.transport
n.transport.vsab <- s['n.vsav']
p.transport.vsab <- n.transport.vsab / n.transport

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(n.transport, n.transport.perso, n.transport.ambu, n.transport.fo, n.transport.heli, n.transport.smur, n.transport.vsab, p.transport.perso, p.transport.ambu, p.transport.fo, p.transport.heli, p.transport.smur, p.transport.vsab)
names(val) <- c("n.transport", "PERSO", "AMBU", "FO", "HELI", "SMUR", "VSAB", "p.PERSO", "P.AMBU", "p.FO", "p.HELI", "p.SMUR", "p.VSAB")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- %(N) d'arrivée personnel: __`r round(n.transport.perso * 100 / n.transport, 2)` %__ (N = `r format.n(n.transport.perso)`)
- %(N) d'arrivée SMUR: __`r round(n.transport.smur * 100 / n.transport, 2)` %__ (N = `r format.n(n.transport.smur)`)
- %(N) d'arrivée VSAB: __`r round(n.transport.vsab * 100 / n.transport, 2)` %__ (N = `r format.n(n.transport.vsab)`)
- %(N) d'arrivée Ambulance: __`r round(n.transport.ambu * 100 / n.transport, 2)` %__ (N = `r format.n(n.transport.ambu)`)

NB : commentaire possible pour expliquer que la somme des 4 pourcentages ci dessus ne fait pas 100 %

### Gravité (CCMU)

```{r ccmu, echo=FALSE, comment=""}
s <- summary.ccmu(dx$GRAVITE)
n.ccmu <- s['n.rens']
```
```{r}
n.ccmu1 <- s['n.ccmu1']
p.ccmu1 <- n.ccmu1 / n.ccmu

n.ccmu2 <- s['n.ccmu2']
p.ccmu2 <- n.ccmu2 / n.ccmu

n.ccmu12 <- n.ccmu1 + n.ccmu2
p.ccmu12 <- p.ccmu1 + p.ccmu2

n.ccmu3 <- s['n.ccmu3']
p.ccmu3 <- n.ccmu3 / n.ccmu
```
```{r}
n.ccmu4 <- s['n.ccmu4']
p.ccmu4 <- n.ccmu4 / n.ccmu

n.ccmu5 <- s['n.ccmu5']
p.ccmu5 <- n.ccmu5 / n.ccmu

n.ccmu45 <- n.ccmu4 + n.ccmu5
p.ccmu45 <- p.ccmu4 + p.ccmu5
```
```{r}
n.ccmu.d <- s['n.ccmud']
p.ccmu.d <- n.ccmu.d / n.ccmu
```
```{r}
n.ccmu.p <- s['n.ccmup']
```
```{r}
p.ccmu.p <- n.ccmu.p / n.ccmu
```

```{r}
# Exhaustivité CCMU 
ccmu.corrigee <- dx$GRAVITE[!(dx$ORIENTATION %in% c("FUGUE","PSA","REO"))] # on ne tient pas compte des RPU dont le motif ORIENTATION = fugue, reo ou psa
n.ccmu.utilisable <- length(ccmu.corrigee)
n.ccmu.conforme <- sum(!is.na(ccmu.corrigee)) # Nombre de RPU 2014 hors orientation = FUGUE, PSA et REO ayant un élément transmis pour la CCMU


#---------------------- Chiffres ---------------------------------------------------------------
# val <- c(n.ccmu12, n.ccmu45, n.ccmu.utilisable, n.ccmu.conforme, s.ccmu)
# names(val) <- c("")
# chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```
- nombre de CCMU renseignés: `r format.n(n.ccmu)`.
- %(N) CCMU 1: __`r round(100 * p.ccmu1, 2)`%__ (n = `r format.n(n.ccmu1)`)
- %(N) CCMU 1 et 2: __`r round(100 * p.ccmu12, 2)`%__ (n = `r format.n(n.ccmu12)`)
- %(N) CCMU 4 et 5: __`r round(100 * p.ccmu45, 2)`%__ (n = `r format.n(n.ccmu45)`)

Exhaustivité CCMU :

- Nombre de RPU 2014 hors orientation = FUGUE, PSA et REO ayant un élément transmis pour la CCMU: __`r format.n(n.ccmu.conforme)`__.

### Diagnostic principal 

Remarque: les chiffres sont dans le document _Codes_regroupement_ORUMIP_ => à rajouter.

- %  Médico-chirurgical: __`r round(136816*100/247196, 2)` %__ (`r format.n(136816)`)
- %  Traumatologique: __`r round(91907*100/247196, 2)` %__ (`r format.n(91907)`)
- %  Psychiatrique: __`r round(6185*100/247196, 2)` %__ (`r format.n(6185)`)
- %  Toxicologique: __`r round(4847*100/247196, 2)` %__ (`r format.n(4847)`)
- %  Autres recours: __`r round(7441*100/247196, 2)` %__ (`r format.n(7441)`)

```{r dp, echo=FALSE}
# load("~/Documents/Stat Resural/Codes_regroupement_ORUMIP/d3.Rda") # d3 contient les données mergées
# source('~/Documents/Stat Resural/Codes_regroupement_ORUMIP/regroupement.R')

# levels(d3$TYPE.URGENCES)
# "Autre recours", "Médico-chirurgical", "Psychiatrique", "Toxicologique", "Traumatologique"
s <- summary.type.urgence(d3$TYPE.URGENCES)

```
- % Médico-chirurgical: `r round(s['p.medico.chir']*100, 2)` %

        - dont :
        
                - % cardio vasculaire:
                - % neuro:
                - % digestif:
                - % respiratoire:
- %  Traumatologique: `r round(s['p.traumato']*100, 2)` %
- %  Psychiatrique: `r round(s['p.psy']*100, 2)` %
- %  Toxicologique: `r round(s['p.tox']*100, 2)` %
- %  Autres recours: `r round(s['p.autres.recours']*100, 2)` %


### Durées de passage

```{r passages, echo=FALSE, comment=""}
# On forme un dataframe avec les heures d'entrées et de sortie auxquelle on rajoute pour certains calculs: Mode_Sortie

# -------- TOUT CE PASSAGE EST REMPLACE PAR duree.passage2() ----------------------
# passages <- dx[, c("ENTREE", "SORTIE", "MODE_SORTIE")] # dataframe entrées-sorties
# passages <- passages[complete.cases(passages),] # on ne conserve que les couples complets
# n.passages <- nrow(passages)
# e <- ymd_hms(passages$ENTREE) # vecteur des entrées
# s <- ymd_hms(passages$SORTIE)
# d <- as.numeric((s-e)/60) # vecteur des durées de passage en minutes
# passages$duree <- d
# # on ne garde que les passages dont la durées > 0 et < ou = 72 heures
# passages <- passages[passages$duree > 0 & passages$duree < 3 * 24 * 60 + 1,]

passages <- duree.passage2(dx)

# analyse simple de la durée:
s <- summary.duree.passage(passages)
n.duree <- s["n"] # nb total de durées
mean.duree <- s['mean']
median.duree <- s['median']
sd.duree <- s['sd']
#s.duree <- summary(passages$duree) # résumé des durées totales de passage

# intervalle interquartile
iqr.duree <- s['q3'] - s['q1']

# histogramme
hist(passages$duree/60, breaks = 72, xlab = "Heures", main = paste0("Durées de passage en ", anc), col= "cornflowerblue", border = "white")

# analyse avancée de la durée
s2 <- summary.passages(passages)

# nb  de passages dont la durée est inférieure à 4 heures:
n.duree.inf.4h <- s2["n.passage4"]
p.duree.inf.4h <- n.duree.inf.4h / n.duree

# nb de passages dont la durée est supérieure à 4 heures:
n.duree.sup.4h <- n.duree - n.duree.inf.4h
p.duree.sup.4h <- 1 - p.duree.inf.4h

#---------------------- OLD ---------------------------------
# nb de passages dont la durée est supérieure à 4 heures:
# duree.sup.4h <- passages$duree[passages$duree > 4 * 60] # vecteur des durées sup 4 h
# n.duree.sup.4h <- length(duree.sup.4h) # nb de passages > 4h
# p.duree.sup.4h <- n.duree.sup.4h / n.duree

# nb  de passages dont la durée est inférieure à 4 heures:
# duree.inf.4h <- passages$duree[passages$duree <= 4 * 60] # vecteur des durées inf 4 h
# n.duree.inf.4h <- length(duree.inf.4h) # nb de passages > 4h
# p.duree.inf.4h <- n.duree.inf.4h / n.duree

# ancien code avec le vecteur durée
# duree <- d[d > 0 & d < 3 * 24 * 60 + 1]
# n.duree <- length(duree) # nb total de durées
# s.duree <- summary(duree) # résumé des durées totales de passage
# mean.duree <- s.duree['Mean']
# median.duree <- s.duree['Median']
# sd.duree <- sd(duree)
# # nb de passages dont la durée est supérieure à 4 heures:
# duree.sup.4h <- duree[duree > 4 * 60] # vecteur des durées sup 4 h
# n.duree.sup.4h <- length(duree.sup.4h) # nb de passages > 4h
# p.duree.sup.4h <- n.duree.sup.4h / n.duree
# 
# # nb  de passages dont la durée est inférieure à 4 heures:
# duree.inf.4h <- duree[duree <= 4 * 60] # vecteur des durées inf 4 h
# n.duree.inf.4h <- length(duree.inf.4h) # nb de passages > 4h
# p.duree.inf.4h <- n.duree.inf.4h / n.duree
# 
# # intervalle interquartile
# iqr.duree <- s.duree['3rd Qu.'] - s.duree['1st Qu.']

# Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'une hospitalisation post-urgences
n.duree.hosp <- s2["n.hosp"]
# durée moyenne de passage si hospitalisation
mean.duree.hosp <- s2["duree.moyenne.passage.hosp"]
median.duree.hosp <- s2["duree.mediane.passage.hosp"]
# Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une hospitalisation post-urgences
n.duree.hosp.inf4h <- s2["n.hosp.passage4"]
# Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'un retour au domicile
n.duree.domicile <- s2["n.domicile"]
# durée moyenne de passage si retour à domicile
mean.duree.domicile <- s2["duree.moyenne.passage.dom"]
median.duree.domicile <- s2["duree.mediane.passage.dom"]
# Nombre de RPU dont la durée de passage est inférieure à 4h lors d'un retour au domicile
n.duree.domicile.inf4h <- s2["n.dom.passage4"]


#---------------------- OLD ---------------------------------
# # Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'une hospitalisation post-urgences
# duree.hosp <- passages[passages$MODE_SORTIE %in% c("Mutation","Transfert"), "duree"]
# n.duree.hosp <- length(duree.hosp)
# # durée moyenne de passage si hospitalisation
# mean.duree.hosp <- mean(duree.hosp)
# median.duree.hosp <- median(duree.hosp)
# # Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une hospitalisation post-urgences
# duree.hosp.inf4h <- passages[passages$MODE_SORTIE %in% c("Mutation","Transfert") & passages$duree < 4*60, "duree"]
# n.duree.hosp.inf4h <- length(duree.hosp.inf4h)
# 
# # Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'un retour au domicile
# duree.domicile <- passages[passages$MODE_SORTIE == "Domicile", "duree"]
# n.duree.domicile <- length(duree.domicile)
# # durée moyenne de passage si retour à domicile
# mean.duree.domicile <- mean(duree.domicile)
# median.duree.domicile <- median(duree.domicile)
# # Nombre de RPU dont la durée de passage est inférieure à 4h lors d'un retour au domicile
# duree.domicile.inf4h <- passages[passages$MODE_SORTIE == "Domicile" & passages$duree < 4*60, "duree"]
# n.duree.domicile.inf4h <- length(duree.domicile.inf4h)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Nombre de RPU dont la durée de passage est comprise entre 0h et 72h: __`r format.n(n.duree)`__
- durée moyenne de passage __`r mean.duree` mn__ (`r mn2h(mean.duree)`).
- écart-type: `r sd.duree` mn (`r mn2h(sd.duree)`).
- médiane: __`r median.duree` mn__ (`r mn2h(median.duree)`).
- nombre de prises en charge > 4 heures: `r format.n(n.duree.sup.4h)` (__`r round(p.duree.sup.4h * 100, 2)` %__).
- nombre de prises en charge inférieures ou égales à 4 heures: `r format.n(n.duree.inf.4h)` (__`r round(p.duree.inf.4h * 100, 2)` %__).

- Lors d’une hospitalisation post-urgences (hospitalisation = mutation + transfert)
    - moyenne durée de passage en cas d’hospitalisation: __`r mean.duree.hosp` mn__.
    - médiane durée de passage en cas d’hospitalisation: __`r median.duree.hosp` mn__.
    
- Lors d’un retour au domicile
    - moyenne durée de passage en cas de retour à domicile: __`r mean.duree.domicile` mn__.
    - médiane durée de passage en cas de retour à domicile: __`r median.duree.domicile` mn__.

(source: temps de passages.Rmd)

### Mode de sortie

```{r mode_sortie, echo=FALSE, comment=""}
s <- summary.mode.sortie(dx$MODE_SORTIE)
n.mode.sortie <- s["n.rens"] # nb de mode de sortie renseigné
n.externes <- s["n.dom"] # nb de sortants
n.mutations <- s["n.mutation"] # nb d'hospitalisés
n.transferts <- s["n.transfert"] # nb de transferts
n.hospitalises <- s["n.hosp"]
n.deces <- s["n.deces"]

#--------------- OLD -----------------------------------
# mode.sortie <- table(dx$MODE_SORTIE) # mode de sortie par type
# n.mode.sortie <- sum(mode.sortie) # nb de mode de sortie renseigné
# n.externes <- mode.sortie['Domicile'] # nb de sortants
# n.mutations <- mode.sortie['Mutation'] # nb d'hospitalisés
# n.transferts <- mode.sortie['Transfert'] # nb de transferts
# n.hospitalises <- n.mutations + n.transferts
# n.deces <- mode.sortie['DCD']

p.externes <- n.externes / n.mode.sortie
p.mutations <- n.mutations / n.mode.sortie
p.transferts <- n.transferts / n.mode.sortie
p.hospitalises <- n.hospitalises / n.mode.sortie
p.deces <- n.deces / n.mode.sortie

# Exhaustivité DESTINATION (lors d'une hospitalisation) 
#Nb de RPU 2014  avec mode de sortie = 6 ou 7 avec un élément transmis pour la destination

#------------- OLD ------------------------
# hosp.dest <- dx[dx$MODE_SORTIE %in% c("Mutation","Transfert"), "DESTINATION"]
# n.hosp.dest <- sum(!is.na(hosp.dest))

s <- summary.destination(dx,correction = TRUE)
# n.hosp.dest <- s["n"] ?
n.hosp.dest <- s["n.rens"]

# Exhaustivité ORIENTATION lors d'une hospitalisation

#------------- OLD ------------------------
# Nb de RPU 2014 avec mode de sortie = 6 ou 7 avec un élement transmis pour l'orientation
# hosp.orient <- dx[dx$MODE_SORTIE %in% c("Mutation","Transfert"), "ORIENTATION"]
# n.hosp.orient <- sum(!is.na(hosp.orient))

s <- summary.orientation(dx,correction = TRUE)
# n.hosp.orient <- s["n"] ?
n.hosp.orient <- s["n.rens"]



#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- % (N) de retour à domicile: __`r round(n.externes * 100 / n.mode.sortie, 2)` %__ (N = `r format.n(n.externes)`)
- % (N) Hospitalisation: __`r round(n.hospitalises * 100 / n.mode.sortie, 2)` %__ (N = `r format.n(n.hospitalises)`)
- % (N) Mutation: __`r round(n.mutations * 100 / n.mode.sortie, 2)` %__ (N = `r format.n(n.mutations)`)
- % (N) Transfert: __`r round(n.transferts * 100 / n.mode.sortie, 2)` %__ (N = `r format.n(n.transferts)`)
- Nb de RPU 2014  avec mode de sortie = 6 ou 7 (hospitalisation) avec un élément transmis pour la destination: __`r n.hosp.dest`__
- Nb de RPU 2014 avec mode de sortie = 6 ou 7 avec un élement transmis pour l'orientation: __`r n.hosp.orient`__


Les chiffres clés de l’activité des SAMU
========================================
 (à partir des données SRVA "officielles")
 
```{r chiffres_2014, echo=FALSE}
# source: samu.Rmd pour l'année 2014
drm <- 480303
smur_primaires <- 19714        
smur_secondaires <- 5070         
smur_neonat <- 537
assu <- 46031

pop.als.2014 <- 1868773

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- Nombre de dossiers de régulation médicale (DRM): `r drm`
- Nombre de SMUR : `r format.n(smur_primaires + smur_secondaires + smur_neonat)`
    - dont primaires: `r format.n(smur_primaires)`
- Nombre d’ambulances privées à la demande du SAMU: `r format.n(assu)`

Organisation
------------
### Nombre de colonnes SMUR terrestres:

SMUR  |  Jour  |  Nuit   
------|--------|------
Wissembourg  |  1  |  1   
Haguenau  |  1  |  1   
Saverne  |  1  |  1   
Strasbourg  |  4  |  3   
Sélestat  |  1  |  1   
Colmar  |  2  |  2     
Mulhouse  |  2  |  2   

### Nombre de SMUR héliportés:

SMUR  |  Jour  |  Nuit   |  Remarques
------|--------|---------|------------
Strasbourg  |  1  |  1   |  convention avec la sécurité civile
Mulhouse  |  1  |  1   |  colonne mutualisée avec le SMUR terrestre

### Nombre de SMUR pédiatriques:

SMUR  |  Jour  |  Nuit   
------|--------|------
Strasbourg (HTP)  |  1  |  1   

   
### SAMU
- Nombre de SAMU: 2
- Nombre de SAMU par bassin populationnel (pour 100 000): `r round(2/pop.als.2014*100000, 2)`
- Nombre de dossier de régulation médicale pour 100.000 h: `r format.n(round(drm/pop.als.2014*100000, 2))`
- Nombre de lignes SMUR par bassin populationnel (pour 100 000): `r round(13/pop.als.2014*100000, 2)`
- Nombre de SU géographiques par bassin populationnel (pour 100 000): `r round(19/pop.als.2014*100000, 2)`


Les chiffres clés de l’activité pédiatrique des services d’urgences (moins de 18 ans)
=====================================================================================

```{r pop18, echo=FALSE, comment=""}
n.jours <- length(unique(as.Date(dx$ENTREE))) # nb de jours pour la période
n.rpu <- nrow(dx)

pop18 <- dx[!is.na(dx$AGE) & dx$AGE < 18,]

# age est un objet de type difftime exprimé en jours
age2 <- as.Date(pop18$ENTREE) - as.Date(pop18$NAISSANCE)
age2 <- as.numeric(age2)

# on retire les valeurs aberrantes: mois de 1 jour et plus de 120 ans
age2 <- age2[age2 > 1 & age2 < 365*18]
age2_an <- round(age2/365, 0)
# crée une nouvelle colonne age à 2 classes: < 28J, 28j-1an, 1-5 ans, 5-10, 10-15, 15-18
ped_jours <- c(1, 28, c(1, 5, 10, 15, 18) * 365) # bornes pour la pédiatrie en jour
# classes FEDORU pour la pédiatrie. La borne inférieure est incluse (include.lowest) et la borne sup est exclue (right = FALSE)
lab <- c("<28j", "28j-1an[", "1-5ans[", "5-10ans[", "10-15ans[", "15-18ans[")
ped <- cut(age2, ped_jours, include.lowest = TRUE, right = FALSE, labels = lab)

# nombre
n.rpu18 <- nrow(pop18)
n.pop18 <- nrow(pop18) # conserver plutôt que n.rpu18

mean.rpu18 <- n.rpu18 / n.jours # Moyenne quotidienne de passages
p.rpu18 <- n.rpu18 * 100 / n.rpu # Taux d'urgences gériatriques

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres end ---------------------------------------------------------------


```

Recueil des données
-------------------

- Nombre de passages dans l'année: `r format.n(n.rpu18)`
- Moyenne quotidienne de passage: `r format.n(mean.rpu18)` passages/j
- Taux d'urgences pédiatriques [(Nb RPU Pédia/ Nb RPU global)x100]: `r format.n(p.rpu18)` %
- TODO: % d'évolution par rapport à l'année N-1(données SAE pour ceux qui n’ont pas d’historique RPU fiable et permettant la comparaison, préciser l’origine des données)

Patients
--------

### Répartition par tranches d'âge
```{r, echo=FALSE, results='asis'}
t.ped <- table(ped)
caption <- paste0("Nombre de RPU pédiatriques en ", anc," par grandes classes d'âge")
#print.xtable(xtable(t.ped, caption = paste0("Nombre de RPU pédiatriques en ", anc," par grandes classes d'âge")), type = xtable.type, format.args=list(big.mark = " ", decimal.mark = ","))

print.table.rpu(t.ped, caption, type = xtable.type)

barplot(table(ped), main = "Pédiatrie")
```

### Pyramide des âges
```{r, echo=FALSE}
# par tranche d'age de 5 ans, borne sup exclue: [0-5[ ans
p <- pyramide.age(pop18, cut = 1, gap = 0.3)
```


```{r sexe18, echo=FALSE, comment=""}
sexe <- table(as.factor(pop18$SEXE))
p.femme18 <- sexe['F']*100/(sexe['F'] + sexe['M']) # % de femmes
p.homme18 <- sexe['M']*100/(sexe['F'] + sexe['M']) # % d'hommes
sex.ratio18 <- sexe['M'] / sexe['F'] # sex ratio
n.hommes18 <- sexe['M']
n.femmes18 <- sexe['F']
tx.masculinite18 <- n.hommes18 / (n.hommes18 + n.femmes18)

# Par sous classe d’âge (GT1:2 classes, moins de 85 et 85 ans et plus)
# n.rpu2 <- tapply(pop18$age2, pop18$age2, length) # effectif de chaque classe

# nb de passages par jour et par sous classe d'age. On applique successivement tapply pour former 2 groupes d'age puis apply pour calculer moyenne, médiane, sd sur chacune des 2 colonnes (groupes d'age).
#n.rpu2.jour <- tapply(as.Date(pop18$ENTREE), list(as.Date(pop18$ENTREE), pop18$age2), length)

# calcul des paramètres par sous classe d'age
# mean.rpu.jour <- apply(n.rpu2.jour, 2, mean)
# median.rpu2.jour <- apply(n.rpu2.jour, 2, median)
# sd.rpu2.jour <- apply(n.rpu2.jour, 2, sd)
# 
# boxplot(n.rpu2.jour, names = c("18-84 ans","85 ans et plus"), ylab = "Fréquence", main = "Passages gériatriques")

# sex-ratio
# n.sexe2 <- tapply(pop18$SEXE, list(pop18$age2, pop18$SEXE), length)
# sr1 <- n.sexe2[1,"M"]/n.sexe2[1,"F"] # moins de 85 ans
# sr2 <- n.sexe2[2,"M"]/n.sexe2[2,"F"] # plus de 85 ans

# tableau desynthèse
# a <- data.frame(n.rpu2,mean.rpu.jour, median.rpu2.jour, c(sr1,sr2) )
# rownames(a) <- c("18-84 ans","85 ans et plus")
# colnames(a) <- c("effectif", "moyenne par jour ","médiane par jour", "sex ratio")
# a

# moyen de transport
t.transport.ped <- factor2table(pop18$TRANSPORT)
# Nombre de RPU avec un moyen de transport renseigné
n.transport.ped.rens <- sum(!is.na(pop18$TRANSPORT))
p.transport.ped.rens <- mean(!is.na(pop18$TRANSPORT))

# Nombre de RPU avec une CCMU renseignée
n.gravite.ped.rens <- sum(!is.na(pop18$GRAVITE))
p.gravite.ped.rens <- mean(!is.na(pop18$GRAVITE))
# nombre de CCMU
t.ccmu.ped <- factor2table(pop18$GRAVITE, TRUE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```
- nombre de garçons: `r format.n(n.hommes18)`
- nombre de filles: `r format.n(n.femmes18)`
- Sex ratio: `r sex.ratio18`
- Pyramide des âges (âge par année, borne supérieure toujours exclue)
- Par sous classes d’âge:
```{r sous_classe_age_ped, echo=FALSE}
 # kable(a)
```

### mode de transport pédiatrique

nombre de RPU pédiatriques avec un moyen de transport renseigné: `r format.n(n.transport.ped.rens)` (p = `r round(p.transport.ped.rens*100, 2)` %)

```{r, echo=FALSE, comment="", results='asis'}
caption <- "Modes de transports pédiatriques"
print.table.rpu(t.transport.ped, caption, type = xtable.type)
``` 

### Gravité des RPU pédiatriques

nombre de CCMU pédiatriques renseignés: `r format.n(n.gravite.ped.rens)` (p = `r round(p.gravite.ped.rens*100, 2)` %)
```{r, echo=FALSE, comment="", results='asis'}
caption <- paste0("Gravité des RPU pédiatriques en ", anc, ".")
print.table.rpu(t.ccmu.ped, caption, type = xtable.type)

```

```{r dp_ped, echo=FALSE}
# load("~/Documents/Stat Resural/Codes_regroupement_ORUMIP/d3.Rda") # d3 contient les données mergées
# source('~/Documents/Stat Resural/Codes_regroupement_ORUMIP/regroupement.R')

# levels(d3$TYPE.URGENCES)
# "Autre recours", "Médico-chirurgical", "Psychiatrique", "Toxicologique", "Traumatologique"
s <- summary.type.urgence(d3$TYPE.URGENCES[d3$AGE < 18])

```
- % Médico-chirurgical: `r round(s['p.medico.chir']*100, 2)` %
        - dont :
                - % cardio vasculaire:
                - % neuro:
                - % digestif:
                - % respiratoire:
- %  Traumatologique: `r round(s['p.traumato']*100, 2)` %
- %  Psychiatrique: `r round(s['p.psy']*100, 2)` %
- %  Toxicologique: `r round(s['p.tox']*100, 2)` %
- %  Autres recours: `r round(s['p.autres.recours']*100, 2)` %



### horaires de passages pédiatriques
```{r passages_ped, echo=FALSE}
# nombre de passages de nuit 20h-8h
n.passages.nuit <- passages2(pop18$ENTREE, "nuit")
p.passages.nuit <- n.passages.nuit / n.pop18

n.passages.nuit.profonde <- passages2(pop18$ENTREE, "nuit_profonde")
p.passages.nuit.profonde <- n.passages.nuit.profonde / n.pop18
#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```
- nombre de passages la nuit: `r format.n(n.passages.nuit)` (p = `r round(p.passages.nuit * 100, 2)` %)
- nombre de passages en nuit profonde: `r format.n(n.passages.nuit.profonde)` (p = `r round(p.passages.nuit.profonde * 100, 2)` %)

### Durée de passage

```{r ped_duree_passage, echo=FALSE}
tmax <- 4 * 60 + 1 # < 4 heures
ped.dp <- duree.passage2(pop18)
ped.conforme <- nrow(ped.dp)
ped.duree.moyenne.passage <- mean(ped.dp$duree)
ped.duree.mediane.passage <- median(ped.dp$duree)
ped.passage4 <- length(ped.dp$duree[ped.dp$duree < tmax]) #nb passages < 4h
s.ped.mode.sortie <- summary(ped.dp$MODE_SORTIE)

ped.hosp.passage4 <- length(ped.dp$duree[ped.dp$duree < tmax & ped.dp$MODE_SORTIE %in% c("Mutation","Transfert")]) #nb passages < 4h et hospitalisation

ped.dom.passage4 <- length(ped.dp$duree[ped.dp$duree < tmax & ped.dp$MODE_SORTIE == "Domicile"]) #nb passages < 4h et retourà domicile

s.mode.sortie <- summary(pop18$MODE_SORTIE)
# Nombre de mutation interne
n.ped.mutation <- s.mode.sortie["Mutation"]
# nb de transfert
n.ped.transfert <- s.mode.sortie["Transfert"]
# nb de retour à domicile
n.ped.domicile <- s.mode.sortie["Domicile"]

```
- Nombre de RPU avec une heure de sortie conforme (]0-72h[: `r format.n(nrow(ped.dp))`
- Durée moyenne de passage (en min): `r ped.duree.moyenne.passage` mn
- Durée médiane de passage (en min): `r ped.duree.mediane.passage` mn
- Nombre de RPU dont la durée de passage est inférieure à 4h: `r format.n(ped.passage4)`
- Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'une hospitalisation post-urgences: `r format.n(s.ped.mode.sortie["Mutation"] + s.ped.mode.sortie["Transfert"])`
- Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'un retour au domicile: `r format.n(s.ped.mode.sortie["Domicile"])`
- Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une hospitalisation post-urgences: `r format.n(ped.hosp.passage4)`
- Nombre de RPU dont la durée de passage est inférieure à 4h lors d'un retour au domicile: `r format.n(ped.dom.passage4)`

- Nombre de RPU avec un mode de sortie renseigné: `r format.n(sum(!is.na(pop18$MODE_SORTIE)))`
- Nombre de mutation interne: `r format.n(n.ped.mutation)`
- Nombre de transfert externe: `r format.n(n.ped.transfert)`
- nombre de retours à domicile: `r format.n(n.ped.domicile)`

Les chiffres clés de l’activité gériatrique des services d’urgences (75 ans et plus)
====================================================================================

En `r anc`, l'Alsace recense `r format.n(155281)` personnes de 75 ans ou plus.

```{r pop75, echo=FALSE}
n.jours <- length(unique(as.Date(dx$ENTREE))) # nb de jours pour la période
n.rpu <- nrow(dx)

pop75 <- dx[!is.na(dx$AGE) & dx$AGE > 74,]
# crée une nouvelle colonne age à 2 classes: mois de 85 ans = 1, 85 ans et plus = 2
pop75$age2 <- ifelse(pop75$AGE < 85, 1, 2)
# nombre
n.rpu75 <- nrow(pop75)
mean.rpu75 <- n.rpu75 / n.jours # Moyenne quotidienne de passages
p.rpu75 <- n.rpu75 * 100 / n.rpu # Taux d'urgences gériatriques

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
Recueil des données
-------------------
- Nombre de passages dans l'année: __`r format.n(n.rpu75)`__
- Taux de recours aux SU de la population gériatrique: __`r round(n.rpu75*100/155281, 2)` %__
- Moyenne quotidienne de passage: __`r format.n(mean.rpu75)` passages/j__
- Taux d'urgences gériatriques [(Nb RPU Géria/ Nb RPU global)x100]: __`r p.rpu75` %__
- % d'évolution par rapport à l'année N-1: _données non fiables_.

Patients
--------
```{r sexe75, echo=FALSE, comment="", results='asis'}
s.sexe75 <- summary.sexe(pop75$SEXE)

# sexe <- table(as.factor(pop75$SEXE))
p.femme75 <- s.sexe75['p.femmes'] # % de femmes
p.homme75 <- s.sexe75['p.hommes'] # % d'hommes
sex.ratio75 <- s.sexe75['sex.ratio'] # sex ratio
n.hommes75 <- s.sexe75['n.hommes']
n.femmes75 <- s.sexe75['n.femmes']
tx.masculinite75 <- s.sexe75['tx.masculinité']

# Par sous classe d’âge (GT1:2 classes, moins de 85 et 85 ans et plus)
n.rpu2 <- tapply(pop75$age2, pop75$age2, length) # effectif de chaque classe

# nb de passages par jour et par sous classe d'age. On applique successivement tapply pour former 2 groupes d'age puis apply pour calculer moyenne, médiane, sd sur chacune des 2 colonnes (groupes d'age).
n.rpu2.jour <- tapply(as.Date(pop75$ENTREE), list(as.Date(pop75$ENTREE), pop75$age2), length)

# calcul des paramètres par sous classe d'age
mean.rpu.jour <- apply(n.rpu2.jour, 2, mean)
median.rpu2.jour <- apply(n.rpu2.jour, 2, median)
sd.rpu2.jour <- apply(n.rpu2.jour, 2, sd)

boxplot(n.rpu2.jour, names = c("75-84 ans","85 ans et plus"), ylab = "Fréquence", main = "Passages gériatriques")

# sex-ratio
n.sexe2 <- tapply(pop75$SEXE, list(pop75$age2, pop75$SEXE), length)
sr1 <- n.sexe2[1,"M"]/n.sexe2[1,"F"] # moins de 85 ans
sr2 <- n.sexe2[2,"M"]/n.sexe2[2,"F"] # plus de 85 ans

# tableau desynthèse
a <- data.frame(n.rpu2,mean.rpu.jour, median.rpu2.jour, c(sr1,sr2) )
rownames(a) <- c("75-84 ans","85 ans et plus")
colnames(a) <- c("effectif", "moyenne par jour ","médiane par jour", "sex ratio")
table.synthese.75 <- a


#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- Nombre d'hommes: `r format.n(n.hommes75)`
- Nombre de femmes: `r format.n(n.femmes75)`
- Sex ratio: `r sex.ratio75`
- Pyramide des âges (âge par année, borne supérieure toujours exclue)
- Par sous classes d’âge (voir \ref{table.synthese.75}):

    - 85 ans ou moins: `r format.n(n.rpu2[1])`
    - plus de 85 ans: `r format.n(n.rpu2[2])`
    
```{r sous_classe_age, echo=FALSE, results='asis'}
print.table.rpu(table.synthese.75, "Caractéristiques des patients de 75 ans et plus, répartis en deux classes d'âge", xtable.type, ref = "table.synthese.75")
```

### Pyramides des ages
```{r, echo=FALSE, fig.height=6}
# par tranche d'age de 5 ans, borne sup exclue: [0-5[ ans
p <- pyramide.age(pop75, cut = 1, gap = 0.1,cex = 0.6)
```


ARRIVÉE
-------

### Horaires de passage

```{r passages75, echo=FALSE}
# vecteur des ENTREES
e <- datetime(pop75$ENTREE)
# extraction de la partie horaire
he <- horaire(e)
# Nb de passages et % en foction de l'horaire
nuit <- passage(he, "nuit")
nuit.profonde <- passage(he, "nuit profonde")
jour <- passage(he, "jour")
```
```{r pds75, echo=FALSE, cache=TRUE}

# Résultat sauvegardé pour tout 2014 dans horaires_pds.Rda; on peut récupérer avec load("horaires_pds.Rda") sous le nom de h.pds puis d'en faire une colonne supplémentaire: dx$HPDS <- h.pds

# s.pds <- summary(as.factor(pop75$HPDS))
s.pds <- table(pdsa(pop75$ENTREE))
n.pds <- s.pds["PDSS"]+ s.pds["PDSWE"] # nb RPU en PDS = PDS semaine + pds WE
p.pds <- n.pds * 100 / sum(s.pds)

s.entree <- summary.entree(as.Date(pop75$ENTREE))

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- Nb de RPU avec date/heure d'entrée renseignés: __`r format.n(s.entree['n'])`__
- %  passages la nuit: __`r nuit[2]*100` %__ (N = `r format.n(nuit[1])`)
- %  passages en horaire de PDS: __`r p.pds` %__ (N = `r format.n(n.pds)`)

### Moyens de transport

```{r moyen_transport, echo=FALSE}
# moyen de transport utilisé pour se rendre aux urgences

s <- summary.transport(pop75$TRANSPORT)

n.moy.perso.75 <- s["n.perso"]
p.moy.perso.75 <- s["p.perso"] # dénominateur = n.rens
n.moy.smur.75 <- s["n.vsav"]
p.moy.smur.75 <- s["p.vsav"]
n.moy.vsab.75 <- s["n.vsav"]
p.moy.vsab.75 <- s["p.vsav"]
n.moy.ambu.75 <- s["n.ambu"]
p.moy.ambu.75 <- s["p.ambu"]
n.moy.na.75 <- s["n.na"]
p.moy.na.75 <- s["p.na"]

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- nombre de moyens de transport: `r format.n(s["n"])`
- nombre de moyens de transport renseignés: `r format.n(s["n.rens"])`
- nombre de moyens personnels: `r format.n(s["n.perso"])`
- nombre de SMUR: `r format.n(s["n.smur"])`
- nombre de VSAV: `r format.n(s["n.vsav"])`
- nombre d'ambulances privées: `r format.n(s["n.ambu"])`

- %  d’arrivées Moyen perso: ___`r p.moy.perso.75` %__ (N = `r format.n(n.moy.perso.75)`)
- %  d'arrivées SMUR: __`r p.moy.smur.75` %__ (N = `r format.n(n.moy.smur.75)`)
- %  d'arrivées VSAV: __`r p.moy.vsab.75` %__ (N = `r format.n(n.moy.vsab.75)`)
- %  d'arrivées ambulance privée: __`r p.moy.ambu.75` %__ (N = `r format.n(n.moy.ambu.75)`)
- % réponses manquantes: __`r round(s["p.na"]*100, 2)` %__

NB : commentaire possible pour expliquer que la somme des 4 pourcentages ci dessus ne fait pas 100 % 

### Gravité

```{r gravite75, echo=FALSE}
ccmu75 <- summary(as.factor(pop75$GRAVITE))
n.ccmu75.1 <- ccmu75[1]
n.ccmu75.45 <- sum(ccmu75[4:5])
p.ccmu75.1 <- n.ccmu75.1 * 100 / n.rpu75
p.ccmu75.45 <- n.ccmu75.45 * 100 / n.rpu75

ccmu75 <- summary.ccmu(pop75$GRAVITE)


#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- Nombre de RPU avec une CCMU renseignée: `r format.n(ccmu75["n"] - ccmu75["n.na"])`
- %  CCMU 1: __`r p.ccmu75.1` %__ (N = `r format.n(n.ccmu75.1)`)
- %  CCMU 4 et 5: __`r p.ccmu75.45` %__ (N = `r format.n(n.ccmu75.45)`)

### Diagnostic principal

```{r dp75, echo=FALSE}
# load("~/Documents/Stat Resural/Codes_regroupement_ORUMIP/d3.Rda") # d3 contient les données mergées
# source('~/Documents/Stat Resural/Codes_regroupement_ORUMIP/regroupement.R')

# levels(d3$TYPE.URGENCES)
# "Autre recours", "Médico-chirurgical", "Psychiatrique", "Toxicologique", "Traumatologique"
s <- summary.type.urgence(d3$TYPE.URGENCES[d3$AGE > 74])
s2 <- summary(d3$CHAPITRE[d3$AGE > 74])
```
- % Médico-chirurgical: `r round(s['p.medico.chir']*100, 2)` %

        - dont :
                - % cardio vasculaire:
                - % neuro:
                - % digestif:
                - % respiratoire:
- %  Traumatologique: `r round(s['p.traumato']*100, 2)` %
- %  Psychiatrique: `r round(s['p.psy']*100, 2)` %
- %  Toxicologique: `r round(s['p.tox']*100, 2)` %
- %  Autres recours: `r round(s['p.autres.recours']*100, 2)` %

### DURÉE

```{r duree_passage_75, echo=FALSE}
# a mutualiser avec le paragraphe ligne 331
passages75 <- pop75[, c("ENTREE", "SORTIE","MODE_SORTIE")] # dataframe entrées-sorties
passages75 <- passages75[complete.cases(passages75),] # on ne conserve que les couples complets
n.passages75 <- nrow(passages75)
e <- ymd_hms(passages75$ENTREE) # vecteur des entrées
s <- ymd_hms(passages75$SORTIE)
d <- as.numeric((s-e)/60) # vecteur des durées de passage en minutes

# on ne garde que les durées > 0 et < ou = 48 heures
duree75 <- d[d > 0 & d < 2 * 24 * 60 + 1]
n.duree75 <- length(duree75) # nb total de durées
s.duree75 <- summary(duree75) # résumé des durées totales de passage
mean.duree75 <- s.duree75['Mean']
median.duree75 <- s.duree75['Median']
sd.duree75 <- sd(duree75)

# nb de passages dont la durée est supérieure à 4 heures:
duree75.sup.4h <- duree75[duree75 > 4 * 60] # vecteur des durées sup 4 h
n.duree75.sup.4h <- length(duree75.sup.4h) # nb de passages > 4h
p.duree75.sup.4h <- n.duree75.sup.4h / n.duree75

# nb de passages dont la durée est inférieure à 4 heures:
n.duree75.inf.4h <- n.duree75 - n.duree75.sup.4h
p.duree75.inf.4h <- n.duree75.inf.4h / n.duree75

iqr.duree75 <- s.duree75['3rd Qu.'] - s.duree75['1st Qu.']

#durée de passage selon le devenir
e <- ymd_hms(passages75$ENTREE) # vecteur des entrées
s <- ymd_hms(passages75$SORTIE)
passages75$duree <- as.numeric((s-e)/60) # vecteur des durées de passage en minutes

# on ne garde que les durées > 0 et < ou = 48 heures
passages75 <- passages75[passages75$duree > 0 & passages75$duree < 2 * 24 * 60 + 1,]
t.mean <- tapply(passages75$duree, factor(passages75$MODE_SORTIE), mean)
t.median <- tapply(passages75$duree, factor(passages75$MODE_SORTIE), median)
t <- rbind(t.mean, t.median)
rownames(t) <- c("Durée moyenne", "Durée médiane")
t

# on regroupe mutation et transfert
passages75$DEVENIR <- as.character(passages75$MODE_SORTIE)
passages75$DEVENIR[passages75$DEVENIR %in% c("Mutation","Transfert")] <-  "Hosp"
median.devenir75 <- tapply(passages75$duree, passages75$DEVENIR, median)
mean.devenir75 <- tapply(passages75$duree, passages75$DEVENIR, mean)

t <- t.test(passages75$duree ~ passages75$DEVENIR)
t
t$p.value

boxplot(passages75$duree ~ passages75$DEVENIR, outline = FALSE, ylab = "Durée de passage (mn)", main = "Durée de passage selon le devenir (age > 75 ans)")
text(1.5,500,"p < 0.001", cex = 0.8, col = "red")

# routine summary.passages
dp75 <- duree.passage2(pop75)
s.dp75 <- summary.passages(dp75)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- Durée moyenne de passage (HORS UHCD) : `r mean.duree75` minutes
- Durée médiane de passage (HORS UHCD) : `r median.duree75` minutes
- %  de passages de moins de 4h : `r p.duree75.inf.4h * 100` %
- lors d’une hospitalisation post-urgences (hospitalisation = mutation + transfert): `r mean.devenir75["Hosp"]` minutes.
- lors d’un retour au domicile: `r mean.devenir75["Domicile"]` minutes.

#### Nouveau
- Nombre de RPU avec une heure de sortie conforme (]0-72h[: `r format.n(s.dp75['n.conforme'])`
- Durée moyenne de passage (en min): `r s.dp75['duree.moyenne.passage']` mn
- Durée médiane de passage (en min): `r s.dp75['duree.mediane.passage']` mn
- Nombre de RPU dont la durée de passage est inférieure à 4h: `r format.n(s.dp75['n.passage4'])`

- Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'une hospitalisation post-urgences: `r format.n(s.dp75['n.hosp'])`

- Nombre de RPU avec une heure de sortie conforme (]0-72h[ lors d'un retour au domicile: `r format.n(s.dp75['n.dom'])`

- Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une hospitalisation post-urgences: `r format.n(s.dp75['n.hosp.passage4'])`

- Nombre de RPU dont la durée de passage est inférieure à 4h lors d'un retour au domicile: `r format.n(s.dp75['n.dom.passage4'])`

### MODE DE SORTIE

```{r sortie75, echo=FALSE}
sortie75 <- summary(as.factor(pop75$MODE_SORTIE))

n.hosp.75 <- sum(sortie75["Mutation"],sortie75["Transfert"])
n.mut.75 <- as.integer(sortie75["Mutation"])
n.trans.75 <- as.integer(sortie75["Transfert"])
n.na.sortie.75 <- as.integer(sortie75["NA's"])
n.dom.75 <- as.integer(sortie75["Domicile"])

p.hosp.75 <- n.hosp.75 * 100 / n.rpu75
p.mut.75 <- n.mut.75 * 100 / n.rpu75
p.trans.75 <- n.trans.75 * 100 / n.rpu75
p.dom.75 <- n.dom.75 * 100 / n.rpu75

tab1(pop75$MODE_SORTIE, sort.group = "decreasing", cex = 0.6, cex.names = 0.8, main = "Mode de sortie et Age sup.ou égal à 75 ans")

# nouvelle fonction
mode.sortie.75 <- summary.mode.sortie(pop75$MODE_SORTIE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- %  d’hospitalisation: `r p.hosp.75` % (N = `r format.n(n.hosp.75)`)
    - % de mutation:`r p.mut.75` % (N = `r format.n(n.mut.75)`)
    - % de transfert:`r p.trans.75` % (N = `r format.n(n.trans.75)`)
- %  de retour à domicile:`r p.dom.75` % (N = `r format.n(n.dom.75)`)

#### rapport régional

- Nombre de RPU avec un mode de sortie renseigné: `r format.n(mode.sortie.75['n'] - mode.sortie.75['n.na'])`
- Nombre de mutation interne: `r format.n(mode.sortie.75['n.mutation'])`
- Nombre de transfert externe: `r format.n(mode.sortie.75['n.transfert'])`
- nombre de retours à domicile: `r format.n(mode.sortie.75['n.dom'])`


Les chiffres clés de l’activité AVC des services d’urgences
===========================================================

```{r init_avc, echo=FALSE}
# load("../../../Stat Resural/Codes_regroupement_ORUMIP/d3.Rda") # fichier mergé d3
# # ajout d'une colonne durée de passage. Nécessite la librairie passage.R
# source('~/Documents/Stat Resural/RPU_2014/Analyse/Temps_passage/passage.R')# pour MAC
d3$DPAS <- duree.passage(d3$ENTREE, d3$SORTIE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

```{r dataframe _avc, echo=FALSE}
# d3 est le chier résultant du merging de d14 (2014) et du fichier des codes de regroupement de la Fedoru. Le temps de calcul étant très long, d3 est précalculé. Voir le dossier CODES DE REGROUPEMENT dans Stat Resural.
AVC<-d3[substr(d3$DP,1,3)>="I60" & substr(d3$DP,1,3)<"I65" | substr(d3$DP,1,3)=="G46" | substr(d3$DP,1,3)=="G45" ,]
AVC$etiologie <- NA
AVC$etiologie[substr(AVC$DP,1,3) %in% c("I60","I61","I62")] <-"HEMO"
AVC$etiologie[substr(AVC$DP,1,3) %in% c("I63","I64")] <-"ISCH"
AVC$etiologie[substr(AVC$DP,1,3) %in% c("I64")] <-"NPRE"
AVC$etiologie[substr(AVC$DP,1,3) %in% c("G45","G46")] <-"AIT"
AVC$etiologie <- as.factor(AVC$etiologie)

n.avc <- nrow(AVC)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
Recueil des données
-------------------

- Nombre d’AVC dans l'année (+ rappeler le pourcentage d’exhaustivité du DP par rapport au nombre de RPU): __`r format.n(n.avc)`__
- Moyenne quotidienne d’AVC: __`r format.n(n.avc/365)` AVC/j__
- %  d’AVC dans l’activité globale: __`r n.avc *100 / nrow(d3)` %__

Répartition des AVC
-------------------
Exemple d'utilisation de la méthode _hist_ appliquée aux objets date-time:

- _x_ = as.Date(AVC$ENTREE)
- _breaks_ est obligatoire: "days", "weeks", "months", "quarters", "years", "secs", "mins", "hours". Utiliser _start.on.monday = TRUE_ si _breaks = "weeks"_.
- _freq_ = TRUE (défaut FALSE) pour afficher les fréquences
- _format_ permet de coisir l'affichage de la date sur l'axe des x [voir](https://stat.ethz.ch/R-manual/R-devel/library/base/html/strptime.html).


```{r hist_avc}
hist(as.Date(AVC$ENTREE), breaks = "months", freq = TRUE, xlab = "Mois", ylab = "Fréquence", main = "Histogramme des AVC vu en SU en 2014", las = 2, col = "cornflowerblue", border = "white")

```


Patients
--------
```{r Patients, echo=FALSE}
avc.sexe <- summary.sexe(AVC$SEXE)
avc.age <- summary.age(AVC$AGE)

# on divise les AVC en 2 groupes: 1 = 85 ans ou moins, 2 = plus de 85 ans
avc.age2 <- ifelse(AVC$AGE < 86, 1, 2)
n.avc.age2 <- table(avc.age2)
p.avc.age2 <- prop.table(table(avc.age2))

s.sexe <- summary(AVC$SEXE)
sr <- avc.sexe['sex.ratio']
avc.h <- avc.sexe['n.hommes']
avc.f <- avc.sexe['n.femmes']

avc.age.renseigne <- avc.age['n.rens']
mean.age <- mean(AVC$AGE)

# découpage INSEE
c.age <- cut(AVC$AGE,breaks = seq(0,120,5), right = FALSE)
table(c.age)
barplot(table(c.age), las = 2, cex.names = 0.8, main = "Histogramme des AVC (découpage INSEE)")

# Découpage FEDORU
c.age <- cut(AVC$AGE,breaks = c(0, 1, 5, 10, 15, 18, 30, 45, 65, 75, 85, 120), right = FALSE)
table(c.age)
barplot(table(c.age), las = 2, cex.names = 0.8, main = "Histogramme des AVC (découpage FEDORU)", col = "cornflowerblue")

# pyramide des ages
avc.pyramide1 <- cut(AVC$AGE, seq(from = 0,to = 120, by = 1), include.lowest = TRUE, right = FALSE)
#table(a)
write.csv(table(avc.pyramide1), file = "avc.pyramide1.csv")

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Sex ratio: `r sr`
- Age moyen: `r round(mean.age, 2)` ans
- Nombre d’AVC par sous classe d’âge (GT1):
    - 85 ans ou moins: `r format.n(n.avc.age2[1])` (`r round(p.avc.age2[1]*100, 2)` %)
    - plus de 85 ans: `r format.n(n.avc.age2[2])` (`r round(p.avc.age2[2]*100, 2)` %)

ARRIVÉE
--------
- Nombre d’AVC et % par tranche d’heure GT1 (matinée, début d’après midi, fin d’après midi, soirée, nuit profonde)

```{r avc_periode, echo=FALSE, results='asis', message=FALSE, warning=FALSE, }
# heures de découpage
p <- c(0, 8, 12, 16, 20, 24)
# légende
np <- c("nuit profonde", "matinée", "début après-midi", "fin après-midi", "soirée")
# extraction des heures à partir du format datetime (http://stackoverflow.com/questions/19292438/split-date-time)
a <- as.numeric(format(as.POSIXct(AVC$ENTREE), "%H"))

x <- cut(a, p, np, right = FALSE)
x2 <- cut(a, p, right = FALSE)

r <- rbind(levels(x2), table(x), round(table(x)*100/sum(table(x)), 2))
rownames(r) <- c("Heures","Nombre","%")
xtable(r, caption = "Arrivées des AVC", label = "avc.arrive")

avc.pds <- tab1(x, cex.names = 0.8, main = "Heure d'admission des AVC", bar.values = "percent", ylab = "%")

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- % AVC le matin: `r avc.pds$output.table[2,2]` %.
- % AVC en début d'après-midi: `r avc.pds$output.table[3,2]` %.
- % AVC en fin d'après-midi: `r avc.pds$output.table[4,2]` %.
- % AVC en soirée: `r avc.pds$output.table[5,2]` %.
- % AVC le nuit profonde: `r avc.pds$output.table[1,2]` %.

- Nombre de passages AVC urgences, déclinaison par département, établissement, année N
```{r avc_finess, echo=FALSE, results='asis'}
t.avc <- tapply(as.Date(AVC$ENTREE), AVC$FINESS, length) # nb AVC par ES
dpr <- dx[!is.na(dx$DP), ] # RPU dont la DP est reneigné
t.diag <- tapply(dpr$DP, dpr$FINESS, length) # nb de  DP renseignés par ES
# round(t.avc * 100 / t.diag % d'AVC parmis les DP par ES
r <- rbind(t.avc, round(t.avc * 100 / t.diag, 2))
rownames(r) <- c("Nombre d'AVC", "% des diagnostics")
xtable(t(r), caption = "Nombre d'AVC par établissement et pourcentage des diagnostics d'AVC parmis l'ensemble des diagnostics principaux évoqués par établissement de santé.", label = "avcParES")

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```


- %  passages en horaire de PDS

```{r avc_pds, echo=FALSE}
s.avc.pds <- summary(as.factor(AVC$HPDS))
# s.avc.pds
p.avc.pds <- round(prop.table(s.avc.pds) * 100, 2)
# p.avc.pds
a <- rbind(s.avc.pds, p.avc.pds)
n <- colnames(a)
n[3] <- "NPDS"
colnames(a) <- n
rownames(a) <- c("Nombre AVC", "% AVC")
kable(a)

# Résumé de la qualité des horaires AVC
s.dateHeure <- summary.dateheure(AVC$ENTREE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

PDSS = horaires de PDS en semaine, PDSWE = horaires de PDS le WE, NPDS = hors horaire de PDS.

- nombre d'AVC aux horaires de PDS en semaine: `r a[2,1]` %
- nombre d'AVC aux horaires de PDS de week-end:`r a[2,2]` %
- nombre d'AVC en dehors des horaires de PDS:`r a[2,3]` %
- Nombre de RPU avec diag AVC avec date et heure d'entrées renseignées: `r format.n(s.dateHeure['n.rens'])`

Mode d'arrivée aux urgences
---------------------------

```{r avc_transport, echo=FALSE}
n.avc.moyen <- summary(factor(AVC$TRANSPORT))
# n.avc.moyen
p.avc.moyen <- round(prop.table(n.avc.moyen)*100, 2)
# p.avc.moyen

# nouvelle fonction
s.avc.transport <- summary.transport(AVC$TRANSPORT)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```
- Nombre de RPU avec moyens de transport précisé: `r format.n(s.avc.transport['n.rens'])`
- %  d’arrivées Moyen perso: `r p.avc.moyen["PERSO"]`%
- %  d'arrivées SMUR: `r p.avc.moyen["SMUR"]`%
- %  d'arrivées VSAV: `r p.avc.moyen["VSAB"]`%
- %  d'arrivées ambulance privée: `r p.avc.moyen["AMBU"]`%
NB : commentaire possible pour expliquer que la somme des 4 pourcentages ci dessus ne fait pas 100 %

Diagnostic principal
--------------------

```{r diag_principal}
t.diag <- table(AVC$etiologie)
p.diag <- prop.table(t.diag)*100
dp.avc <- rbind(t.diag, p.diag)
rownames(dp.avc) <- c("nombre","%")

# Exhaustivité CCMU 
dp.corrigee <- dx$DP[!(dx$ORIENTATION %in% c("FUGUE","PSA","REO"))] # on ne tient pas compte des RPU dont le motif ORIENTATION = fugue, reo ou psa
n.dp.utilisable <- length(dp.corrigee)
n.dp.conforme <- sum(!is.na(dp.corrigee)) # Nombre de RPU 2014 hors orientation = FUGUE, PSA et REO ayant un élément transmis pour la CCMU

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

- Nombre d’AVC ischémiques et %: `r format.n(dp.avc[1,3])` (`r dp.avc[2,3]` %)
- Nombre d’AVC hémorragiques et %: `r format.n(dp.avc[1,2])` (`r dp.avc[2,2]` %)
- Nombre d’AIT et %: `r format.n(dp.avc[1,1])` (`r dp.avc[2,1]` %)
- Nombre de codes "symptomatiques" (hémiplégie, aphasie, amaurose, etc…) et %: `r format.n(dp.avc[1,4])` (`r dp.avc[2,4]` %)

NB : se référer à l’annexe 4 pour les regroupements.

DURÉE
-----
Voir ligne 333

Voir les routines de RPU_2014/Analyse/Temps_passage/passage.R et notamment __temps de passage__.

```{r avc_passage}
# source('~/Documents/Stat Resural/RPU_2014/Analyse/Temps_passage/passage.R')# pour MAC
# on ne garde que les durées de passage non nulles et < 48H
ts.avc <- AVC[!is.na(AVC$DPAS) & AVC$DPAS > 0 & AVC$DPAS <= 2*24*60, "DPAS"]
mean.ts.avc <- mean(as.numeric(ts.avc))
median.ts.avc <- median(as.numeric(ts.avc))
n.ts.avc.inf4h <- length(ts.avc < 4 * 60) # nombre AVC restés moins de 4 heures aux urgences
p.ts.avc.inf4h <- n.ts.avc.inf4h / nrow(AVC)

# nouvelles routines
dp.avc <- duree.passage2(AVC)
s.dp.avc <- summary.passages(dp.avc)


#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Nombre de RPU avec une heure de sortie conforme (]0-72h[: `r format.n(s.dp.avc['n.conforme'])`
- Durée moyenne de passage des Patients PEC pour AVC (en min): `r format.n(s.dp.avc['duree.moyenne.passage'])`
- Durée médiane de passage des Patients PEC pour AVC (en min): `r format.n(s.dp.avc['duree.mediane.passage'])`
- Nombre de RPU ac diag AVC dont la durée de passage est inférieure à 4h: `r format.n(s.dp.avc['n.passage4'])`

- Durée de passage (HORS UHCD) année N: moyenne __`r mean.ts.avc`__ minutes, et médiane __`r median.ts.avc`__ minutes.
- % de passages de moins de 4h `r p.ts.avc.inf4h`


MODE DE SORTIE
--------------
```{r avc_mode_sortie}
avc.sortie <- tab1(factor(AVC$MODE_SORTIE), main = "AVC - Mode de sortie")
s.sortie <- summary.mode.sortie(AVC$MODE_SORTIE)

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------
```

- Nombre de RPU ac diag. AVC avec un mode de sortie renseigné: `r s.sortie['n.rens']`
- % d’hospitalisation: `r avc.sortie$output.table[1,3] + avc.sortie$output.table[2,3]` % (N = `r s.sortie['n.hosp']`)
- % de mutation: `r avc.sortie$output.table[1,3]` % (N = `r s.sortie['n.mutation']`)
- % de transfert: `r avc.sortie$output.table[2,3]` % (N = `r s.sortie['n.transfert']`)
- % de retour à domicile: `r avc.sortie$output.table[3,3]` % (N = `r s.sortie['n.dom']`)

Orientation
----------
- Répartition par orientation en pourcentage, année N

```{r avc_orientation}
s.avc <- summary(factor(AVC$ORIENTATION))
avc.chir <- s.avc['CHIR']
avc.fugue <- s.avc['FUGUE']
avc.hdt <- s.avc['HDT']
avc.ho <- s.avc['HO']
avc.med <- s.avc['MED']
avc.obst <- s.avc['OBST']
avc.psa <- s.avc['PSA']
avc.rea <- s.avc['REA']
avc.reo <- s.avc['REO']
avc.sc <- s.avc['SC']
avc.scam <- s.avc['SCAM']
avc.si <- s.avc['SI']
avc.uhcd <- s.avc['UHCD']
avc.na <- s.avc["NA's"]

#---------------------- Chiffres ---------------------------------------------------------------
val <- c(NA)
names(val) <- c("")
chiffres <- c(chiffres, val)
#---------------------- Chiffres ---------------------------------------------------------------

```

```{r star_orientation, echo=FALSE, results='asis', comment=FALSE}
stargazer(s.avc, title = "Orientation des AVC", label = "orientation")

```

Analyse par type d'étblissement
===============================

```{r, echo=FALSE}
# Voir routine __analyse-type_etablissement__ (rapport_2014.R).
```

SU de CHU
---------

Un seul établissement __HUS__ avec 3 SU:

- NHC
- HTP Adultes
- HTP Pédiatrie

__AVERTISSEMENT__: _Les chiffres des HUS sont très difficilement interprétables en 2014. Du fait d'une anomalie du logiciel récupérant les RPU avant de les transmettre au concentrateur régional, le nombreux RPU sont manquants ou incomplet. L'erreur a été corrigée au mois d'octobre 2014 et seul les deux derniers mois de 2014 sont fiables._

```{r chu, echo=FALSE}
es <- dx[dx$FINESS == "Hus",]
es_nom <- "CHU Alsace "

# à gerder ou supprimer mais redondant
 a <- analyse_type_etablissement(es)

    # nombre de passages déclarés
    n.passages <- nrow(es)

    # Nombre de RPU avec un âge renseigné
    age <- summary.age(es$AGE)

    # Nombre de RPU avec un code postal renseigné
    cp <- summary.cp(es$CODE_POSTAL)
    
    # passages de nuit
    nuit <- passage(horaire(es$ENTREE), "nuit")

    # passage en PDS
    pds <- table(pdsa(es$ENTREE))

    #Nombre de RPU avec une date et heure d'entrée renseignées
    entree <- summary.dateheure(es$ENTREE)
    sortie <- summary.dateheure(es$SORTIE)

    # nombre avec moyen de transport renseigné
    s <- summary.transport(es$TRANSPORT)
    sn <- c(s['n.na'], s['n.rens'], s['n.perso'], s['n.ambu'], s['n.vsav'], s['n.smur'], s['n.heli'], s['n.fo'])
    sp <- c(s['p.na'], s['p.rens'], s['p.perso'], s['p.ambu'], s['p.vsav'], s['p.smur'], s['p.heli'], s['p.fo'])
    r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Non Renseignés","Renseignés","Moyen personnel","Ambulance","VSAV","SMUR","Hélicoptère", "Forces de l'ordre")
    transport <- r

    
    # nombre avec CCMU renseigné
    s <- summary.ccmu(es$GRAVITE)
    
    sn <- c(s['n.na'], s['n.rens'], s['n.ccmu1'], s['n.ccmu2'], s['n.ccmu3'], s['n.ccmu4'], s['n.ccmu5'], s['n.ccmup'], s['n.ccmud'])
    sp <- c(s['p.na'], s['p.rens'], s['p.ccmu1'], s['p.ccmu2'], s['p.ccmu3'], s['p.ccmu4'], s['p.ccmu5'], s['p.ccmup'], s['p.ccmud'])
    r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Non Renseignés","Renseignés","CCMU1","CCMU2","CCMU3","CCMU4","CCMU5", "CCMU PSY", "CCMU DCD")
    ccmu <- r

    # nombre de sorties conformes
sdp <- summary.passages(duree.passage2(es))
n.dp <- nrow(es)

sn <- c(sdp['n.mode_sortie.rens'], sdp['n.orientation.rens'], sdp['n.passage4'], sdp['n.hosp.passage4'], sdp['n.dom.passage4'], sdp['n.dom'], sdp['n.hosp'], sdp['n.transfert'], sdp['n.mutation'], sdp['n.deces'])

sp <- c(sdp['p.mode_sortie.rens'], sdp['p.orientation.rens'], sdp['p.passage4'], sdp['p.hosp.passage4'], sdp['p.dom.passage4'], sdp['p.dom'], sdp['p.hosp'], sdp['p.transfert'], sdp['p.mutation'], sdp['p.deces'])

r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Nombre de modes de sortie renseignés", "Nombre de modes d'orientation renseignés", "Passages de moins de 4 heures","Passages < 4h puis hospitalisation","Passages < 4h puis retour à domicile","Nombre total de retours à domicile","Nombre total d'hospitalisations","nombre total de transferts","Nombre total de mutations", "Nombre de déçès")
    passages <- r

    # Nombre de RPU avec un mode de sortie renseigné (tous les RPU)
    ms <- summary.mode.sortie(es$MODE_SORTIE)

```

- Nombre de passages déclarés: `r format.n(n.passages)` en `r anc`.
- Nombre de RPU avec un âge renseigné: `r format.n(age['n.rens'])`.
- Nombre de RPU avec un code postal renseigné: `r format.n(cp['n.rens'])`.
- Nombre de passages par jour de la semaine:

```{r, echo=FALSE, results='asis'}
# par jour de semaine
    print.summary.rpu(summary.wday(es$ENTREE), cnames = c("Jour","n","%"), caption = "Nombre de RPU par jour de semaine")
```
        
- Nombre d'âges renseignés: `r format.n(age['n.rens'])`
        
```{r, echo=FALSE, results='asis'}
    s <- summary.age(es$AGE)
    a <- s[c('n.inf1an', 'n.inf15ans', 'n.75ans')]
    print.summary.rpu(a, cnames = c("Tranches d'âge","n", "%"), rnames = c("Moins de 1 an", "Moins de 15 ans", "75 ans et plus"), caption = paste0(es_nom, anc, " - Nombre de RPU par tranches d'âge"))
```

- Nombre de passages la nuit: `r format.n(nuit[1])` (`r round(nuit[2]*100, 2)` %)

- Nombre de passages en horaire de PDS:
```{r, echo=FALSE, results='asis'}
# par jour de semaine
    print.summary.rpu(pds, cnames = c("Jour","n","%"), caption = "Passages aux urgences aux horaires de permanence des soins: Passages totaux (NPDS), passages  en semaine (PDSS), passages le week-end (PDSWE)")
```

-  Nombre de RPU avec une date-heure d'entrée renseignés: `r format.n(entree["n.rens"])` (`r round(entree['p.rens']*100, 2)` %)
-  Nombre de RPU avec une date-heure de sortie renseignés: `r format.n(sortie['n.rens'])` (`r round(sortie['p.rens']*100, 2)` %)

- Moyen de transport utilisé pour se rendre aux urgences:
```{r, echo=FALSE, results='asis'}
print.table.rpu(transport, caption = paste0(es_nom, anc, " - Moyens de transport"))
```

- Gravité des RPU évaluée selon la classification CCMU:
```{r, echo=FALSE, results='asis'}
print.table.rpu(ccmu, caption = paste0(es_nom, anc, " - Gravité des RPU évaluée selon la classification CCMU"))
```

### Durée de passages

La durée de passage aux urgences est la différence entre l'heure de sortie et l'heure d'entrée au SU. Dans les calculs qui suivent ne sont retenus que les RPU qui disposent d'une heure d'entrée et de sortie. Une durée de passage est considérée comme __conforme__ si elle est positive et inférieure à 72 heures (FEDORU).

- Nombre de durées de passage conformes: `r format.n(sdp['n.conforme'])` (`r round(sdp['n.conforme']*100/n.dp, 2)` %)
- Durée moyenne de passage: `r format.n(sdp['duree.moyenne.passage'])` mn
- Durée médiane de passage: `r format.n(sdp['duree.mediane.passage'])` mn
- Durée moyenne de passage en cas de retour à domicile: `r format.n(sdp['duree.moyenne.passage.dom'])` mn
- Durée médiane de passage en cas de retour à domicile: `r format.n(sdp['duree.mediane.passage.dom'])` mn
- Durée moyenne de passage en cas d'hospitalisation: `r format.n(sdp['duree.moyenne.passage.hosp'])` mn
- Durée médiane de passage en cas d'hospitalisation: `r format.n(sdp['duree.mediane.passage.hosp'])` mn
```{r, echo=FALSE, results='asis'}
print.table.rpu(passages, caption = paste0(es_nom, anc, " - Durées de passage selon le devenir du patient"))
```


SU d'ES siège de SAMU, non CHU
------------------------------

Un seul établissement: CH de Mulhouse avec 2 implantations:

- Emile Muller (Adultes + Pédiatrie traumatique)
- Hasenrain (Pédiatrie médicale)
```{r, echo=FALSE}
es <- dx[dx$FINESS == "Hus",]
es_nom <- "ES non CHU siège de SAMU "

# à gerder ou supprimer mais redondant
 a <- analyse_type_etablissement(es)

    # nombre de passages déclarés
    n.passages <- nrow(es)

    # Nombre de RPU avec un âge renseigné
    age <- summary.age(es$AGE)

    # Nombre de RPU avec un code postal renseigné
    cp <- summary.cp(es$CODE_POSTAL)
    
    # passages de nuit
    nuit <- passage(horaire(es$ENTREE), "nuit")

    # passage en PDS
    pds <- table(pdsa(es$ENTREE))

    #Nombre de RPU avec une date et heure d'entrée renseignées
    entree <- summary.dateheure(es$ENTREE)
    sortie <- summary.dateheure(es$SORTIE)

    # nombre avec moyen de transport renseigné
    s <- summary.transport(es$TRANSPORT)
    sn <- c(s['n.na'], s['n.rens'], s['n.perso'], s['n.ambu'], s['n.vsav'], s['n.smur'], s['n.heli'], s['n.fo'])
    sp <- c(s['p.na'], s['p.rens'], s['p.perso'], s['p.ambu'], s['p.vsav'], s['p.smur'], s['p.heli'], s['p.fo'])
    r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Non Renseignés","Renseignés","Moyen personnel","Ambulance","VSAV","SMUR","Hélicoptère", "Forces de l'ordre")
    transport <- r

    
    # nombre avec CCMU renseigné
    s <- summary.ccmu(es$GRAVITE)
    
    sn <- c(s['n.na'], s['n.rens'], s['n.ccmu1'], s['n.ccmu2'], s['n.ccmu3'], s['n.ccmu4'], s['n.ccmu5'], s['n.ccmup'], s['n.ccmud'])
    sp <- c(s['p.na'], s['p.rens'], s['p.ccmu1'], s['p.ccmu2'], s['p.ccmu3'], s['p.ccmu4'], s['p.ccmu5'], s['p.ccmup'], s['p.ccmud'])
    r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Non Renseignés","Renseignés","CCMU1","CCMU2","CCMU3","CCMU4","CCMU5", "CCMU PSY", "CCMU DCD")
    ccmu <- r

    # nombre de sorties conformes
sdp <- summary.passages(duree.passage2(es))
n.dp <- nrow(es)

sn <- c(sdp['n.mode_sortie.rens'], sdp['n.orientation.rens'], sdp['n.passage4'], sdp['n.hosp.passage4'], sdp['n.dom.passage4'], sdp['n.dom'], sdp['n.hosp'], sdp['n.transfert'], sdp['n.mutation'], sdp['n.deces'])

sp <- c(sdp['p.mode_sortie.rens'], sdp['p.orientation.rens'], sdp['p.passage4'], sdp['p.hosp.passage4'], sdp['p.dom.passage4'], sdp['p.dom'], sdp['p.hosp'], sdp['p.transfert'], sdp['p.mutation'], sdp['p.deces'])

r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Nombre de modes de sortie renseignés", "Nombre de modes d'orientation renseignés", "Passages de moins de 4 heures","Passages < 4h puis hospitalisation","Passages < 4h puis retour à domicile","Nombre total de retours à domicile","Nombre total d'hospitalisations","nombre total de transferts","Nombre total de mutations", "Nombre de déçès")
    passages <- r

    # Nombre de RPU avec un mode de sortie renseigné (tous les RPU)
    ms <- summary.mode.sortie(es$MODE_SORTIE)

```

- Nombre de passages déclarés: `r format.n(n.passages)` en `r anc`.
- Nombre de RPU avec un âge renseigné: `r format.n(age['n.rens'])`.
- Nombre de RPU avec un code postal renseigné: `r format.n(cp['n.rens'])`.
- Nombre de passages par jour de la semaine:

```{r, echo=FALSE, results='asis'}
# par jour de semaine
    print.summary.rpu(summary.wday(es$ENTREE), cnames = c("Jour","n","%"), caption = "Nombre de RPU par jour de semaine")
```
        
- Nombre d'âges renseignés: `r format.n(age['n.rens'])`
        
```{r, echo=FALSE, results='asis'}
    s <- summary.age(es$AGE)
    a <- s[c('n.inf1an', 'n.inf15ans', 'n.75ans')]
    print.summary.rpu(a, cnames = c("Tranches d'âge","n", "%"), rnames = c("Moins de 1 an", "Moins de 15 ans", "75 ans et plus"), caption = paste0(es_nom, anc, " - Nombre de RPU par tranches d'âge"))
```

- Nombre de passages la nuit: `r format.n(nuit[1])` (`r round(nuit[2]*100, 2)` %)

- Nombre de passages en horaire de PDS:
```{r, echo=FALSE, results='asis'}
# par jour de semaine
    print.summary.rpu(pds, cnames = c("Jour","n","%"), caption = "Passages aux urgences aux horaires de permanence des soins: Passages totaux (NPDS), passages  en semaine (PDSS), passages le week-end (PDSWE)")
```

-  Nombre de RPU avec une date-heure d'entrée renseignés: `r format.n(entree["n.rens"])` (`r round(entree['p.rens']*100, 2)` %)
-  Nombre de RPU avec une date-heure de sortie renseignés: `r format.n(sortie['n.rens'])` (`r round(sortie['p.rens']*100, 2)` %)

- Moyen de transport utilisé pour se rendre aux urgences:
```{r, echo=FALSE, results='asis'}
print.table.rpu(transport, caption = paste0(es_nom, anc, " - Moyens de transport"))
```

- Gravité des RPU évaluée selon la classification CCMU:
```{r, echo=FALSE, results='asis'}
print.table.rpu(ccmu, caption = paste0(es_nom, anc, " - Gravité des RPU évaluée selon la classification CCMU"))
```

### Durée de passages

La durée de passage aux urgences est la différence entre l'heure de sortie et l'heure d'entrée au SU. Dans les calculs qui suivent ne sont retenus que les RPU qui disposent d'une heure d'entrée et de sortie. Une durée de passage est considérée comme __conforme__ si elle est positive et inférieure à 72 heures (FEDORU).

- Nombre de durées de passage conformes: `r format.n(sdp['n.conforme'])` (`r round(sdp['n.conforme']*100/n.dp, 2)` %)
- Durée moyenne de passage: `r format.n(sdp['duree.moyenne.passage'])` mn
- Durée médiane de passage: `r format.n(sdp['duree.mediane.passage'])` mn
- Durée moyenne de passage en cas de retour à domicile: `r format.n(sdp['duree.moyenne.passage.dom'])` mn
- Durée médiane de passage en cas de retour à domicile: `r format.n(sdp['duree.mediane.passage.dom'])` mn
- Durée moyenne de passage en cas d'hospitalisation: `r format.n(sdp['duree.moyenne.passage.hosp'])` mn
- Durée médiane de passage en cas d'hospitalisation: `r format.n(sdp['duree.mediane.passage.hosp'])` mn
```{r, echo=FALSE, results='asis'}
print.table.rpu(passages, caption = paste0(es_nom, anc, " - Durées de passage selon le devenir du patient"))
```

SU avec SMUR non siège de SAMU
------------------------------

Les SU non sièges de SAMU, avec SMUR représentent cinq établissements:

- CH Wissembourg
- CH haguenau
- CH Saverne
- CH Sélestat
- CH Colmar

```{r sus, echo=FALSE, comment=""}
es <- dx[dx$FINESS %in% c("Wis","Hag","Sav","Sel","Col"),]
es_nom <- "ES non sièges de SAMU, avec SMUR "
# analyse_type_etablissement(es)

# nombre de passages déclarés
#     nrow(es)
#     # Nombre de RPU avec un âge renseigné
#     summary.age(es$AGE)
#     # Nombre de RPU avec un code postal renseigné
#     summary.cp(es$CODE_POSTAL)
#     
#     # par jour de semaine
#     summary.wday(es$ENTREE)
#     summary.age(es$AGE)
#     # passages de nuit
#     passage(horaire(es$ENTREE), "nuit")
#     # passage en PDS
#     table(pdsa(es$ENTREE))
#     #Nombre de RPU avec une date et heure d'entrée renseignées
#     summary.dateheure(es$ENTREE)
#     # nombre avec moyen de transport renseigné
#     summary.transport(es$TRANSPORT)
#     # nombre avec CCMU renseigné
#     summary.ccmu(es$GRAVITE)
#     # nombre de sorties conformes
#     summary.passages(duree.passage2(es))
#     # Nombre de RPU avec un mode de sortie renseigné
#     summary.mode.sortie(es$MODE_SORTIE)

# à gerder ou supprimer mais redondant
 a <- analyse_type_etablissement(es)

    # nombre de passages déclarés
    n.passages <- nrow(es)

    # Nombre de RPU avec un âge renseigné
    age <- summary.age(es$AGE)

    # Nombre de RPU avec un code postal renseigné
    cp <- summary.cp(es$CODE_POSTAL)
    
    # passages de nuit
    nuit <- passage(horaire(es$ENTREE), "nuit")

    # passage en PDS
    pds <- table(pdsa(es$ENTREE))

    #Nombre de RPU avec une date et heure d'entrée renseignées
    entree <- summary.dateheure(es$ENTREE)
    sortie <- summary.dateheure(es$SORTIE)

    # nombre avec moyen de transport renseigné
    s <- summary.transport(es$TRANSPORT)
    sn <- c(s['n.na'], s['n.rens'], s['n.perso'], s['n.ambu'], s['n.vsav'], s['n.smur'], s['n.heli'], s['n.fo'])
    sp <- c(s['p.na'], s['p.rens'], s['p.perso'], s['p.ambu'], s['p.vsav'], s['p.smur'], s['p.heli'], s['p.fo'])
    r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Non Renseignés","Renseignés","Moyen personnel","Ambulance","VSAV","SMUR","Hélicoptère", "Forces de l'ordre")
    transport <- r

    
    # nombre avec CCMU renseigné
    s <- summary.ccmu(es$GRAVITE)
    
    sn <- c(s['n.na'], s['n.rens'], s['n.ccmu1'], s['n.ccmu2'], s['n.ccmu3'], s['n.ccmu4'], s['n.ccmu5'], s['n.ccmup'], s['n.ccmud'])
    sp <- c(s['p.na'], s['p.rens'], s['p.ccmu1'], s['p.ccmu2'], s['p.ccmu3'], s['p.ccmu4'], s['p.ccmu5'], s['p.ccmup'], s['p.ccmud'])
    r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Non Renseignés","Renseignés","CCMU1","CCMU2","CCMU3","CCMU4","CCMU5", "CCMU PSY", "CCMU DCD")
    ccmu <- r

    # nombre de sorties conformes
sdp <- summary.passages(duree.passage2(es))
n.dp <- nrow(es)

sn <- c(sdp['n.mode_sortie.rens'], sdp['n.orientation.rens'], sdp['n.passage4'], sdp['n.hosp.passage4'], sdp['n.dom.passage4'], sdp['n.dom'], sdp['n.hosp'], sdp['n.transfert'], sdp['n.mutation'], sdp['n.deces'])

sp <- c(sdp['p.mode_sortie.rens'], sdp['p.orientation.rens'], sdp['p.passage4'], sdp['p.hosp.passage4'], sdp['p.dom.passage4'], sdp['p.dom'], sdp['p.hosp'], sdp['p.transfert'], sdp['p.mutation'], sdp['p.deces'])

r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Nombre de modes de sortie renseignés", "Nombre de modes d'orientation renseignés", "Passages de moins de 4 heures","Passages < 4h puis hospitalisation","Passages < 4h puis retour à domicile","Nombre total de retours à domicile","Nombre total d'hospitalisations","nombre total de transferts","Nombre total de mutations", "Nombre de déçès")
    passages <- r

    # Nombre de RPU avec un mode de sortie renseigné (tous les RPU)
    ms <- summary.mode.sortie(es$MODE_SORTIE)

```

- Nombre de passages déclarés: `r format.n(n.passages)` en `r anc`.
- Nombre de RPU avec un âge renseigné: `r format.n(age['n.rens'])`.
- Nombre de RPU avec un code postal renseigné: `r format.n(cp['n.rens'])`.
- Nombre de passages par jour de la semaine:

```{r, echo=FALSE, results='asis'}
# par jour de semaine
    print.summary.rpu(summary.wday(es$ENTREE), cnames = c("Jour","n","%"), caption = "Nombre de RPU par jour de semaine")
```
        
- Nombre d'âges renseignés: `r format.n(age['n.rens'])`
        
```{r, echo=FALSE, results='asis'}
    s <- summary.age(es$AGE)
    a <- s[c('n.inf1an', 'n.inf15ans', 'n.75ans')]
    print.summary.rpu(a, cnames = c("Tranches d'âge","n", "%"), rnames = c("Moins de 1 an", "Moins de 15 ans", "75 ans et plus"), caption = paste0(es_nom, anc, " - Nombre de RPU par tranches d'âge"))
```

- Nombre de passages la nuit: `r format.n(nuit[1])` (`r round(nuit[2]*100, 2)` %)

- Nombre de passages en horaire de PDS:
```{r, echo=FALSE, results='asis'}
# par jour de semaine
    print.summary.rpu(pds, cnames = c("Jour","n","%"), caption = "Passages aux urgences aux horaires de permanence des soins: Passages totaux (NPDS), passages  en semaine (PDSS), passages le week-end (PDSWE)")
```

-  Nombre de RPU avec une date-heure d'entrée renseignés: `r format.n(entree["n.rens"])` (`r round(entree['p.rens']*100, 2)` %)
-  Nombre de RPU avec une date-heure de sortie renseignés: `r format.n(sortie['n.rens'])` (`r round(sortie['p.rens']*100, 2)` %)

- Moyen de transport utilisé pour se rendre aux urgences:
```{r, echo=FALSE, results='asis'}
print.table.rpu(transport, caption = paste0(es_nom, anc, " - Moyens de transport"))
```

- Gravité des RPU évaluée selon la classification CCMU:
```{r, echo=FALSE, results='asis'}
print.table.rpu(ccmu, caption = paste0(es_nom, anc, " - Gravité des RPU évaluée selon la classification CCMU"))
```

### Durée de passages

La durée de passage aux urgences est la différence entre l'heure de sortie et l'heure d'entrée au SU. Dans les calculs qui suivent ne sont retenus que les RPU qui disposent d'une heure d'entrée et de sortie. Une durée de passage est considérée comme __conforme__ si elle est positive et inférieure à 72 heures (FEDORU).

- Nombre de durées de passage conformes: `r format.n(sdp['n.conforme'])` (`r round(sdp['n.conforme']*100/n.dp, 2)` %)
- Durée moyenne de passage: `r format.n(sdp['duree.moyenne.passage'])` mn
- Durée médiane de passage: `r format.n(sdp['duree.mediane.passage'])` mn
- Durée moyenne de passage en cas de retour à domicile: `r format.n(sdp['duree.moyenne.passage.dom'])` mn
- Durée médiane de passage en cas de retour à domicile: `r format.n(sdp['duree.mediane.passage.dom'])` mn
- Durée moyenne de passage en cas d'hospitalisation: `r format.n(sdp['duree.moyenne.passage.hosp'])` mn
- Durée médiane de passage en cas d'hospitalisation: `r format.n(sdp['duree.mediane.passage.hosp'])` mn
```{r, echo=FALSE, results='asis'}
print.table.rpu(passages, caption = paste0(es_nom, anc, " - Durées de passage selon le devenir du patient"))
```


SU non SMUR, non SAMU, non CHU
------------------------------

ES avec SU isolé (pas de SMUR associé): 8 établissements

- Ste Anne
- Ste Odile
- Diaconat Strasbourg
- CH de Guebwiller
- CH de Thann (pas de RPU)
- CH d'Altkirch
- Clinique des 3 frontières
- Roosvelt
- Fonderie

```{r esnsns, echo= FALSE, comment=""}

es <- NULL
es <- dx[dx$FINESS  %in% c("Ane","Odi","Dts","Geb","Alk","3Fr","Ros","Dia"),]
es_nom <- "ES avec SU non SMUR"

#es.simple <- analyse_type_etablissement(es)
# es.simple

# # nombre de passages déclarés
# nrow(es)
# # Nombre de RPU avec un âge renseigné
# summary.age(es$AGE)
# # Nombre de RPU avec un code postal renseigné
# summary.cp(es$CODE_POSTAL)
# 
# # par jour de semaine
# summary.wday(es$ENTREE)
# summary.age(es$AGE)
# # passages de nuit
# passage(horaire(es$ENTREE), "nuit")
# # passage en PDS
# table(pdsa(es$ENTREE))
# #Nombre de RPU avec une date et heure d'entrée renseignées
# summary.dateheure(es$ENTREE)
# # nombre avec moyen de transport renseigné
# summary.transport(es$TRANSPORT)
# # nombre avec CCMU renseigné
# summary.ccmu(es$GRAVITE)
# # nombre de sorties conformes
# summary.passages(duree.passage2(es))
# # Nombre de RPU avec un mode de sortie renseigné
# summary.mode.sortie(es$MODE_SORTIE)

# à gerder ou supprimer mais redondant
 a <- analyse_type_etablissement(es)

    # nombre de passages déclarés
    n.passages <- nrow(es)

    # Nombre de RPU avec un âge renseigné
    age <- summary.age(es$AGE)

    # Nombre de RPU avec un code postal renseigné
    cp <- summary.cp(es$CODE_POSTAL)
    
    # passages de nuit
    nuit <- passage(horaire(es$ENTREE), "nuit")

    # passage en PDS
    pds <- table(pdsa(es$ENTREE))

    #Nombre de RPU avec une date et heure d'entrée renseignées
    entree <- summary.dateheure(es$ENTREE)
    sortie <- summary.dateheure(es$SORTIE)

    # nombre avec moyen de transport renseigné
    s <- summary.transport(es$TRANSPORT)
    sn <- c(s['n.na'], s['n.rens'], s['n.perso'], s['n.ambu'], s['n.vsav'], s['n.smur'], s['n.heli'], s['n.fo'])
    sp <- c(s['p.na'], s['p.rens'], s['p.perso'], s['p.ambu'], s['p.vsav'], s['p.smur'], s['p.heli'], s['p.fo'])
    r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Non Renseignés","Renseignés","Moyen personnel","Ambulance","VSAV","SMUR","Hélicoptère", "Forces de l'ordre")
    transport <- r

    
    # nombre avec CCMU renseigné
    s <- summary.ccmu(es$GRAVITE)
    
    sn <- c(s['n.na'], s['n.rens'], s['n.ccmu1'], s['n.ccmu2'], s['n.ccmu3'], s['n.ccmu4'], s['n.ccmu5'], s['n.ccmup'], s['n.ccmud'])
    sp <- c(s['p.na'], s['p.rens'], s['p.ccmu1'], s['p.ccmu2'], s['p.ccmu3'], s['p.ccmu4'], s['p.ccmu5'], s['p.ccmup'], s['p.ccmud'])
    r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Non Renseignés","Renseignés","CCMU1","CCMU2","CCMU3","CCMU4","CCMU5", "CCMU PSY", "CCMU DCD")
    ccmu <- r

    # nombre de sorties conformes
sdp <- summary.passages(duree.passage2(es))
n.dp <- nrow(es)

sn <- c(sdp['n.mode_sortie.rens'], sdp['n.orientation.rens'], sdp['n.passage4'], sdp['n.hosp.passage4'], sdp['n.dom.passage4'], sdp['n.dom'], sdp['n.hosp'], sdp['n.transfert'], sdp['n.mutation'], sdp['n.deces'])

sp <- c(sdp['p.mode_sortie.rens'], sdp['p.orientation.rens'], sdp['p.passage4'], sdp['p.hosp.passage4'], sdp['p.dom.passage4'], sdp['p.dom'], sdp['p.hosp'], sdp['p.transfert'], sdp['p.mutation'], sdp['p.deces'])

r <- rbind(sn, round(sp*100,2))
    r <- t(r)
    colnames(r) <- c("n", "%")
    rownames(r) <- c("Nombre de modes de sortie renseignés", "Nombre de modes d'orientation renseignés", "Passages de moins de 4 heures","Passages < 4h puis hospitalisation","Passages < 4h puis retour à domicile","Nombre total de retours à domicile","Nombre total d'hospitalisations","nombre total de transferts","Nombre total de mutations", "Nombre de déçès")
    passages <- r

    # Nombre de RPU avec un mode de sortie renseigné (tous les RPU)
    ms <- summary.mode.sortie(es$MODE_SORTIE)

```

- Nombre de passages déclarés: `r format.n(n.passages)` en `r anc`.
- Nombre de RPU avec un âge renseigné: `r format.n(age['n.rens'])`.
- Nombre de RPU avec un code postal renseigné: `r format.n(cp['n.rens'])`.
- Nombre de passages par jour de la semaine:

```{r, echo=FALSE, results='asis'}
# par jour de semaine
    print.summary.rpu(summary.wday(es$ENTREE), cnames = c("Jour","n","%"), caption = "Nombre de RPU par jour de semaine")
```
        
- Nombre d'âges renseignés: `r format.n(age['n.rens'])`
        
```{r, echo=FALSE, results='asis'}
    s <- summary.age(es$AGE)
    a <- s[c('n.inf1an', 'n.inf15ans', 'n.75ans')]
    print.summary.rpu(a, cnames = c("Tranches d'âge","n", "%"), rnames = c("Moins de 1 an", "Moins de 15 ans", "75 ans et plus"), caption = paste0(es_nom, anc, " - Nombre de RPU par tranches d'âge"))
```

- Nombre de passages la nuit: `r format.n(nuit[1])` (`r round(nuit[2]*100, 2)` %)

- Nombre de passages en horaire de PDS:
```{r, echo=FALSE, results='asis'}
# par jour de semaine
    print.summary.rpu(pds, cnames = c("Jour","n","%"), caption = "Passages aux urgences aux horaires de permanence des soins: Passages totaux (NPDS), passages  en semaine (PDSS), passages le week-end (PDSWE)")
```

-  Nombre de RPU avec une date-heure d'entrée renseignés: `r format.n(entree["n.rens"])` (`r round(entree['p.rens']*100, 2)` %)
-  Nombre de RPU avec une date-heure de sortie renseignés: `r format.n(sortie['n.rens'])` (`r round(sortie['p.rens']*100, 2)` %)

- Moyen de transport utilisé pour se rendre aux urgences:
```{r, echo=FALSE, results='asis'}
print.table.rpu(transport, caption = paste0(es_nom, anc, " - Moyens de transport"))
```

- Gravité des RPU évaluée selon la classification CCMU:
```{r, echo=FALSE, results='asis'}
print.table.rpu(ccmu, caption = paste0(es_nom, anc, " - Gravité des RPU évaluée selon la classification CCMU"))
```

### Durée de passages

La durée de passage aux urgences est la différence entre l'heure de sortie et l'heure d'entrée au SU. Dans les calculs qui suivent ne sont retenus que les RPU qui disposent d'une heure d'entrée et de sortie. Une durée de passage est considérée comme __conforme__ si elle est positive et inférieure à 72 heures (FEDORU).

- Nombre de durées de passage conformes: `r format.n(sdp['n.conforme'])` (`r round(sdp['n.conforme']*100/n.dp, 2)` %)
- Durée moyenne de passage: `r format.n(sdp['duree.moyenne.passage'])` mn
- Durée médiane de passage: `r format.n(sdp['duree.mediane.passage'])` mn
- Durée moyenne de passage en cas de retour à domicile: `r format.n(sdp['duree.moyenne.passage.dom'])` mn
- Durée médiane de passage en cas de retour à domicile: `r format.n(sdp['duree.mediane.passage.dom'])` mn
- Durée moyenne de passage en cas d'hospitalisation: `r format.n(sdp['duree.moyenne.passage.hosp'])` mn
- Durée médiane de passage en cas d'hospitalisation: `r format.n(sdp['duree.mediane.passage.hosp'])` mn
```{r, echo=FALSE, results='asis'}
print.table.rpu(passages, caption = paste0(es_nom, anc, " - Durées de passage selon le devenir du patient"))
```

Test de la routine et tableau compact
=====================================

En fonction du type de structures d'urgences disponibles, on peut distingur quatre catégories d'établissements:

- Catégorie 1: Les SU de CHU (SAMU, SMUR, Urgences adultes et enfants).
- Catégorie 2: Les SU non CHU, sièges de SAMU.
- Catégorie 3: Les SU non CHU, non SAMU, sièges de SMUR.
- Catégorie 4: Les SU simples.

```{r tableauSU, echo=FALSE, results='asis'}
es <- dx[dx$FINESS %in% c("Wis","Hag","Sav","Sel","Col"),]
es.smur <- analyse_type_etablissement(es)
es <- dx[dx$FINESS == "Hus",]
es.chu <- analyse_type_etablissement(es)
es <- dx[dx$FINESS == "Mul",]
es.samu <- analyse_type_etablissement(es)
es <- dx[dx$FINESS  %in% c("Ane","Odi","Dts","Geb","Alk","3Fr","Ros","Dia"),]
es.simple <- analyse_type_etablissement(es)

t <- cbind(es.chu, es.samu, es.smur, es.simple)
colnames(t) <- c("Catégorie 1", "Catégorie 2", "Catégorie 3", "Catégorie 4")

# rownames(t) <- c("Nombre de RPU", "Nombre d'âges renseignés", "Nombre de moins de 1 an", "Nombre de moins de 15 ans", "Nombre de 75 ans et plus", "Nombre de RPU avec un code postal renseigné", "Nombre de Patients ne venant pas de la région (étranger compris)", "Nombre de passages les lundis", "Nombre de passages les mardis", "Nombre de passages les mercredis", "Nombre de passages les jeudis", "Nombre de passages les vendredis", "Nombre de passages les samedis", "Nombre de passages les dimanchess", "Nombre de RPU la nuit (20h-8h)", "Nombre de RPU en horaire de PDS", "Nombre de RPU avec une date et heure d'entrée renseignées", "Nombre de RPU avec un moyen de transport renseigné", "Amené par la police", "Arrivés par hélicoptère", "Nombre de moyen personnel", "Nombre de SMUR", "Nombre de VSAV", "Nombre d'ambulances", "Nombre de RPU avec une CCMU renseignée", "CCMU 1", "CCMU 2", "CCMU 3", "CCMU 4", "CCMU 5", "CCMU P", "CCMU D", "CCMU 4 et 5", "Nombre de RPU avec une heure de sortie conforme (]0-72h[", "Durée moyenne de passage (en min)", "Durée médiane de passage (en min)", "Nombre de RPU dont la durée de passage est inférieure à 4h", "Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une hospitalisation post-urgences", "Nombre de RPU dont la durée de passage est inférieure à 4h lors d'une retour au domicile", "Nombre de RPU lors d'un retour au domicile", "Nombre de RPU lors d'une hospitalisation post-urgences",  "Nombre de RPU avec transfert", "Nombre de RPU avec décès", "Nombre de RPU avec un mode de sortie renseigné", "Nombre de RPU avec mutation")

print.xtable(xtable(t, caption = paste0("Chiffres clés des SU d'Alsace en ", anc, " - Synthèse des données en fonction de la catégorie d'établissement.")))

```
En pourcentages:

```{r, echo=FALSE, results='asis'}
es <- dx[dx$FINESS %in% c("Wis","Hag","Sav","Sel","Col"),]
es.smur <- analyse_type_etablissement_p(es)
es <- dx[dx$FINESS == "Hus",]
es.chu <- analyse_type_etablissement_p(es)
es <- dx[dx$FINESS == "Mul",]
es.samu <- analyse_type_etablissement_p(es)
es <- dx[dx$FINESS  %in% c("Ane","Odi","Dts","Geb","Alk","3Fr","Ros","Dia"),]
es.simple <- analyse_type_etablissement_p(es)

t <- cbind(es.chu, es.samu, es.smur, es.simple)
t <- round(t * 100, 2)
colnames(t) <- c("Catégorie 1", "Catégorie 2", "Catégorie 3", "Catégorie 4")

print.xtable(xtable(t, caption = paste0("Chiffres clés des SU d'Alsace en ", anc, " - Synthèse des données, exprimées en pourcentage, en fonction de la catégorie d'établissement.")))

```

Doublons ?
==========

- Age moyen, année N
- Répartition par classe âge en pourcentage, année N
- Répartition par sexe en pourcentage, année N
- TOP 5 pourcentage par code CIM 10, année N
- Répartition we/semaine en pourcentage, année N
- Répartition par tranche heure en pourcentage, année N

```{r enregistre_chiffres, echo=FALSE}
 write.csv(chiffres, row.names = names(chiffres), file = paste("chiffres_", anc, ".csv", sep = ""))
```

Comparaison à hôpitaux constants
================================
Introduit dans le rapoort 2014: pour évaluer le taux de progression 2013-2014, on compare uniquement les hôpitaux de 2014 qui transmettaient déjà des données en 2013:
```{r}
# données 2013 
if(host == "MacBook-Air-de-JCB.local" | host == "Air-de-JCB"){
    load("../../../Stat Resural/RPU_2013/rpu2013d0112_2.Rda")
}else{
    load("~/Documents/Resural/Stat Resural/RPU_2013/rpu2013d0112_2.Rda")} # XPS

t <- table(d1$FINESS)
hop2013 <- names(t) # liste des hôpitaux de référence
```

```{r}
# données 2014
if(host == "MacBook-Air-de-JCB.local" | host == "Air-de-JCB"){
    load("../../../Stat Resural/RPU_2014/rpu2014d0112_c2.Rda")
}else{
    load("~/Documents/Resural/Stat Resural/RPU_2014/rpu2014d0112_c2.Rda")} # XPS

# RPU 2014 récupérés sur la base des ES actifs en 2013
rpu2014.hop.constants <- d14[d14$FINESS %in% hop2013,]
# taux de progression
c6 <- nrow(rpu2014.hop.constants)
c7 <- nrow(d1)
(c6-c7)/c7
# progression pour les moins de 18 ans
age18 <- rpu2014.hop.constants$AGE[rpu2014.hop.constants$AGE < 18]
length(age18)
# progression pour les 75 ans et 9lus
age75 <- rpu2014.hop.constants$AGE[rpu2014.hop.constants$AGE > 74]
length(age75)

```



ANNEXES
=======

ANNEXE 1 : Définitions
----------------------
```{r def, child = '2-Definitions/definitions.Rmd'}
```

ANNEXE 2 : Diagramme de complétude des RPU
------------------------------------------

ANNEXE 3 : Calcul du TARRU
--------------------------

Information de session
======================

```{r session, echo=FALSE, comment=""}
sessionInfo()

citation()
```

Temps de calcul
===============

```{r end}
proc.time() - ptm
```
